<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>StudentFocus | Task Manager</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      :root {
        --primary: #6c63ff;
        --primary-dark: #5a52d9;
        --secondary: #4a47a3;
        --bg: #f4f6f8;
        --card-bg: #ffffff;
        --text: #2d3436;
        --text-light: #636e72;
        --border: #dfe6e9;
        --danger: #ff6b6b;
        --warning: #feca57;
        --success: #1dd1a1;
        --high-prio: #ff7675;
        --med-prio: #fdcb6e;
        --low-prio: #55efc4;
        --shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        --shadow-lg: 0 10px 40px rgba(0, 0, 0, 0.12);
      }

      [data-theme="dark"] {
        --bg: #0f0f1a;
        --card-bg: #1a1a2e;
        --text: #eceff4;
        --text-light: #aab2c0;
        --border: #2d2d44;
        --shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
        --shadow-lg: 0 10px 40px rgba(0, 0, 0, 0.5);
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Poppins", sans-serif;
      }

      body {
        background-color: var(--bg);
        color: var(--text);
        min-height: 100vh;
        transition: all 0.3s ease;
      }

      /* Scrollbar */
      ::-webkit-scrollbar {
        width: 8px;
      }
      ::-webkit-scrollbar-track {
        background: var(--bg);
      }
      ::-webkit-scrollbar-thumb {
        background: var(--primary);
        border-radius: 4px;
      }

      .hidden {
        display: none !important;
      }

      .btn-primary {
        background: linear-gradient(
          135deg,
          var(--primary),
          var(--primary-dark)
        );
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(108, 99, 255, 0.3);
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(108, 99, 255, 0.4);
      }

      .btn-secondary {
        background: transparent;
        border: 2px solid var(--primary);
        color: var(--primary);
        padding: 10px 20px;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.3s ease;
      }

      .btn-secondary:hover {
        background: var(--primary);
        color: white;
      }

      .highlight {
        color: var(--primary);
      }
      .danger-text {
        color: var(--danger);
        font-weight: bold;
      }

      /* Glassmorphism effect */
      .glass {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      /* Auth Section */
      #auth-section {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 20px;
      }

      .auth-container {
        background: var(--card-bg);
        padding: 2.5rem;
        border-radius: 24px;
        box-shadow: var(--shadow-lg);
        width: 100%;
        max-width: 420px;
        text-align: center;
        animation: slideUp 0.5s ease;
      }

      @keyframes slideUp {
        from {
          opacity: 0;
          transform: translateY(30px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .auth-container h1 {
        font-size: 2rem;
        margin-bottom: 0.5rem;
      }

      .auth-container > p {
        color: var(--text-light);
        margin-bottom: 1.5rem;
      }

      .auth-tabs {
        display: flex;
        margin: 1.5rem 0;
        background: var(--bg);
        border-radius: 12px;
        padding: 5px;
      }

      .auth-tabs button {
        flex: 1;
        background: none;
        border: none;
        padding: 12px;
        cursor: pointer;
        color: var(--text-light);
        border-radius: 10px;
        font-weight: 500;
        transition: all 0.3s ease;
      }

      .auth-tabs button.active {
        background: var(--primary);
        color: white;
        font-weight: 600;
      }

      .auth-container form {
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }

      .auth-container input {
        padding: 14px 18px;
        border-radius: 12px;
        border: 2px solid var(--border);
        background: var(--bg);
        color: var(--text);
        font-size: 1rem;
        transition: all 0.3s ease;
      }

      .auth-container input:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 4px rgba(108, 99, 255, 0.1);
      }

      /* App Header */
      header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem 5%;
        background: var(--card-bg);
        box-shadow: var(--shadow);
        position: sticky;
        top: 0;
        z-index: 100;
      }

      .logo {
        font-size: 1.5rem;
        font-weight: 700;
      }

      .header-controls {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .header-controls button {
        background: var(--bg);
        border: none;
        font-size: 1.1rem;
        padding: 10px 12px;
        border-radius: 10px;
        cursor: pointer;
        color: var(--text);
        transition: all 0.3s ease;
      }

      .header-controls button:hover {
        background: var(--primary);
        color: white;
      }

      .user-badge {
        background: var(--bg);
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 0.85rem;
        color: var(--text-light);
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .user-badge i {
        color: var(--primary);
      }

      /* Stats */
      .stats-container {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 1rem;
        padding: 1.5rem 5%;
      }

      @media (max-width: 768px) {
        .stats-container {
          grid-template-columns: repeat(2, 1fr);
        }
      }

      .stat-card {
        background: var(--card-bg);
        padding: 1.25rem;
        border-radius: 16px;
        box-shadow: var(--shadow);
        text-align: center;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
      }

      .stat-card::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 4px;
        background: linear-gradient(90deg, var(--primary), var(--secondary));
      }

      .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: var(--shadow-lg);
      }

      .stat-card h3 {
        font-size: 0.85rem;
        color: var(--text-light);
        margin-bottom: 0.5rem;
      }

      .stat-card span {
        font-size: 1.8rem;
        font-weight: 700;
        color: var(--primary);
      }

      .progress-bar-bg {
        background: var(--border);
        height: 10px;
        border-radius: 5px;
        overflow: hidden;
        margin: 10px 0;
      }

      .progress-fill {
        background: linear-gradient(90deg, var(--primary), var(--success));
        height: 100%;
        transition: width 0.5s ease;
        border-radius: 5px;
      }

      /* Search Bar */
      .search-container {
        padding: 0 5%;
        margin-bottom: 1rem;
      }

      .search-box {
        display: flex;
        align-items: center;
        background: var(--card-bg);
        border-radius: 12px;
        padding: 12px 20px;
        box-shadow: var(--shadow);
        gap: 12px;
      }

      .search-box i {
        color: var(--text-light);
      }

      .search-box input {
        flex: 1;
        border: none;
        background: transparent;
        font-size: 1rem;
        color: var(--text);
        outline: none;
      }

      /* Controls */
      .controls-container {
        padding: 0 5%;
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
        gap: 1rem;
        align-items: center;
        margin-bottom: 1rem;
      }

      .filters {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
      }

      select {
        padding: 10px 15px;
        border-radius: 10px;
        border: 2px solid var(--border);
        background: var(--card-bg);
        color: var(--text);
        cursor: pointer;
        font-weight: 500;
        transition: all 0.3s ease;
      }

      select:focus {
        outline: none;
        border-color: var(--primary);
      }

      .btn-icon {
        background: var(--card-bg);
        border: 2px solid var(--border);
        padding: 10px 14px;
        border-radius: 10px;
        cursor: pointer;
        color: var(--text);
        transition: all 0.3s ease;
      }

      .btn-icon:hover {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
      }

      /* Add Task Form */
      #task-form {
        background: var(--card-bg);
        margin: 0 5% 1.5rem;
        padding: 1.5rem;
        border-radius: 16px;
        box-shadow: var(--shadow);
        display: flex;
        flex-direction: column;
        gap: 1rem;
        animation: slideDown 0.3s ease;
      }

      @keyframes slideDown {
        from {
          opacity: 0;
          transform: translateY(-20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .form-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
      }

      .form-header h3 {
        color: var(--primary);
      }

      .form-row {
        display: flex;
        gap: 1rem;
      }

      .form-row > * {
        flex: 1;
        padding: 12px 16px;
        border-radius: 10px;
        border: 2px solid var(--border);
        background: var(--bg);
        color: var(--text);
        font-size: 0.95rem;
        transition: all 0.3s ease;
      }

      .form-row > *:focus {
        outline: none;
        border-color: var(--primary);
      }

      @media (max-width: 600px) {
        .form-row {
          flex-direction: column;
        }
      }

      /* Task List */
      .list-tabs {
        padding: 0 5%;
        margin-bottom: 1rem;
        display: flex;
        gap: 1rem;
      }

      .list-tab {
        background: none;
        border: none;
        font-size: 1rem;
        padding: 10px 20px;
        cursor: pointer;
        color: var(--text-light);
        border-radius: 10px;
        transition: all 0.3s ease;
        font-weight: 500;
      }

      .list-tab.active {
        background: var(--primary);
        color: white;
      }

      .task-list {
        padding: 0 5% 2rem;
        display: grid;
        gap: 1rem;
      }

      /* Task Card */
      .task-card {
        background: var(--card-bg);
        padding: 1.25rem;
        border-radius: 16px;
        box-shadow: var(--shadow);
        border-left: 5px solid var(--border);
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: all 0.3s ease;
        animation: fadeIn 0.3s ease;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: scale(0.95);
        }
        to {
          opacity: 1;
          transform: scale(1);
        }
      }

      .task-card:hover {
        transform: translateX(5px);
        box-shadow: var(--shadow-lg);
      }

      .task-card.priority-High {
        border-left-color: var(--high-prio);
      }
      .task-card.priority-Medium {
        border-left-color: var(--med-prio);
      }
      .task-card.priority-Low {
        border-left-color: var(--low-prio);
      }

      .task-card.overdue {
        background: rgba(255, 107, 107, 0.1);
        border: 2px solid var(--danger);
        border-left-width: 5px;
      }

      .task-info {
        flex: 1;
      }

      .task-info h4 {
        margin-bottom: 6px;
        font-size: 1.1rem;
      }

      .task-meta {
        font-size: 0.85rem;
        color: var(--text-light);
        display: flex;
        gap: 12px;
        align-items: center;
        flex-wrap: wrap;
      }

      .badge {
        padding: 4px 12px;
        border-radius: 20px;
        background: var(--bg);
        font-size: 0.75rem;
        font-weight: 600;
      }

      .badge-danger {
        background: var(--danger);
        color: white;
      }

      .badge-warning {
        background: var(--warning);
        color: #333;
      }

      .task-actions {
        display: flex;
        gap: 8px;
      }

      .task-actions button {
        background: var(--bg);
        border: none;
        cursor: pointer;
        padding: 10px 12px;
        font-size: 1rem;
        color: var(--text-light);
        border-radius: 10px;
        transition: all 0.3s ease;
      }

      .task-actions button:hover {
        transform: scale(1.1);
      }
      .check-btn:hover {
        background: var(--success);
        color: white !important;
      }
      .edit-btn:hover {
        background: var(--primary);
        color: white !important;
      }
      .delete-btn:hover {
        background: var(--danger);
        color: white !important;
      }

      .task-card.completed {
        opacity: 0.6;
        background: var(--bg);
      }

      .task-card.completed h4 {
        text-decoration: line-through;
      }

      /* Empty State */
      .empty-state {
        text-align: center;
        padding: 3rem;
        color: var(--text-light);
      }

      .empty-state i {
        font-size: 4rem;
        margin-bottom: 1rem;
        color: var(--border);
      }

      /* Loading Spinner */
      .loading-spinner {
        text-align: center;
        padding: 2rem;
        color: var(--text-light);
      }

      .loading-spinner i {
        font-size: 2rem;
        color: var(--primary);
      }

      /* Toast */
      #toast-container {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 1000;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .toast {
        background: var(--card-bg);
        color: var(--text);
        padding: 14px 24px;
        border-radius: 12px;
        box-shadow: var(--shadow-lg);
        border-left: 4px solid var(--primary);
        animation: slideIn 0.3s ease;
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .toast.error {
        border-left-color: var(--danger);
      }
      .toast.success {
        border-left-color: var(--success);
      }

      @keyframes slideIn {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      /* Edit Modal */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        animation: fadeIn 0.2s ease;
      }

      .modal {
        background: var(--card-bg);
        padding: 2rem;
        border-radius: 20px;
        width: 90%;
        max-width: 500px;
        box-shadow: var(--shadow-lg);
        animation: slideUp 0.3s ease;
      }

      .modal h3 {
        margin-bottom: 1.5rem;
        color: var(--primary);
      }

      .modal-actions {
        display: flex;
        gap: 1rem;
        margin-top: 1.5rem;
        justify-content: flex-end;
      }

      /* Footer */
      footer {
        text-align: center;
        padding: 1rem;
        color: var(--text-light);
        font-size: 0.85rem;
      }

      /* Responsive */
      @media (max-width: 600px) {
        .controls-container {
          flex-direction: column;
          align-items: stretch;
        }
        .filters {
          justify-content: center;
        }
        .task-card {
          flex-direction: column;
          align-items: flex-start;
          gap: 1rem;
        }
        .task-actions {
          align-self: flex-end;
        }
        .user-badge {
          display: none;
        }
      }
    </style>
  </head>
  <body>
    <!-- NOTIFICATIONS (TOASTS) -->
    <div id="toast-container"></div>

    <!-- AUTH SECTION -->
    <section id="auth-section" class="active-section">
      <div class="auth-container">
        <h1>Student<span class="highlight">Focus</span></h1>
        <p>üìö Manage assignments, exams, and study goals.</p>

        <div class="auth-tabs">
          <button id="tab-login" class="active">Login</button>
          <button id="tab-register">Sign Up</button>
        </div>

        <form id="login-form">
          <input
            type="email"
            id="login-email"
            placeholder="üìß Email"
            required
          />
          <input
            type="password"
            id="login-password"
            placeholder="üîí Password"
            required
          />
          <button type="submit" class="btn-primary">
            <i class="fas fa-sign-in-alt"></i> Login
          </button>
        </form>

        <form id="register-form" class="hidden">
          <input
            type="text"
            id="reg-name"
            placeholder="üë§ Full Name"
            required
          />
          <input type="email" id="reg-email" placeholder="üìß Email" required />
          <input
            type="password"
            id="reg-password"
            placeholder="üîí Password (6+ chars)"
            required
          />
          <button type="submit" class="btn-primary">
            <i class="fas fa-user-plus"></i> Create Account
          </button>
        </form>
      </div>
    </section>

    <!-- APP DASHBOARD -->
    <section id="app-section" class="hidden">
      <header>
        <div class="logo">Student<span class="highlight">Focus</span></div>
        <div class="header-controls">
          <div class="user-badge" id="user-badge">
            <i class="fas fa-user-circle"></i>
            <span id="user-name">User</span>
          </div>
          <button id="theme-toggle" title="Toggle Theme">
            <i class="fas fa-moon"></i>
          </button>
          <button id="logout-btn" title="Logout">
            <i class="fas fa-sign-out-alt"></i>
          </button>
        </div>
      </header>

      <main>
        <!-- STATS BAR -->
        <div class="stats-container">
          <div class="stat-card">
            <h3>üìä Progress</h3>
            <div class="progress-bar-bg">
              <div
                id="progress-fill"
                class="progress-fill"
                style="width: 0%"
              ></div>
            </div>
            <span id="progress-text">0%</span>
          </div>
          <div class="stat-card">
            <h3>üìù Total Tasks</h3>
            <span id="total-count">0</span>
          </div>
          <div class="stat-card">
            <h3>‚è≥ Pending</h3>
            <span id="pending-count">0</span>
          </div>
          <div class="stat-card">
            <h3>üî• Due Soon</h3>
            <span id="due-soon-count" class="danger-text">0</span>
          </div>
        </div>

        <!-- SEARCH BAR -->
        <div class="search-container">
          <div class="search-box">
            <i class="fas fa-search"></i>
            <input
              type="text"
              id="search-input"
              placeholder="Search tasks..."
            />
          </div>
        </div>

        <!-- CONTROLS & ADD TASK -->
        <div class="controls-container">
          <button id="toggle-form-btn" class="btn-secondary">
            <i class="fas fa-plus"></i> New Task
          </button>

          <div class="filters">
            <select id="filter-category">
              <option value="all">üìÅ All Categories</option>
              <option value="Homework">üìù Homework</option>
              <option value="Project">üíº Project</option>
              <option value="Exam">üìñ Exam</option>
              <option value="Personal">üë§ Personal</option>
            </select>
            <select id="sort-tasks">
              <option value="date-asc">üìÖ Due: Soonest</option>
              <option value="date-desc">üìÖ Due: Latest</option>
              <option value="priority">‚ö° Priority</option>
              <option value="created">üÜï Recently Added</option>
            </select>
            <button id="export-btn" class="btn-icon" title="Export CSV">
              <i class="fas fa-file-csv"></i>
            </button>
          </div>
        </div>

        <!-- ADD TASK FORM (Collapsible) -->
        <form id="task-form" class="hidden">
          <div class="form-header">
            <h3><i class="fas fa-plus-circle"></i> Add New Task</h3>
            <button type="button" id="close-form-btn" class="btn-icon">
              <i class="fas fa-times"></i>
            </button>
          </div>
          <div class="form-row">
            <input
              type="text"
              id="task-title"
              placeholder="üìå Task Title"
              required
            />
            <input
              type="text"
              id="task-subject"
              placeholder="üìö Subject"
              required
            />
          </div>
          <div class="form-row">
            <select id="task-category">
              <option value="Homework">üìù Homework</option>
              <option value="Project">üíº Project</option>
              <option value="Exam">üìñ Exam</option>
              <option value="Personal">üë§ Personal</option>
            </select>
            <select id="task-priority">
              <option value="Low">üü¢ Low Priority</option>
              <option value="Medium" selected>üü° Medium Priority</option>
              <option value="High">üî¥ High Priority</option>
            </select>
          </div>
          <div class="form-row">
            <input type="datetime-local" id="task-due" required />
            <input
              type="text"
              id="task-notes"
              placeholder="üìù Notes (Optional)"
            />
          </div>
          <button type="submit" class="btn-primary">
            <i class="fas fa-check"></i> Add Task
          </button>
        </form>

        <!-- TABS -->
        <div class="list-tabs">
          <button class="list-tab active" data-view="pending">
            <i class="fas fa-clock"></i> To Do
          </button>
          <button class="list-tab" data-view="completed">
            <i class="fas fa-check-circle"></i> Completed
          </button>
          <button class="list-tab" data-view="all">
            <i class="fas fa-list"></i> All
          </button>
        </div>

        <!-- TASK LIST -->
        <div id="task-list" class="task-list">
          <div class="loading-spinner">
            <i class="fas fa-spinner fa-spin"></i>
            <p>Loading tasks...</p>
          </div>
        </div>
      </main>

      <footer>Made with ‚ù§Ô∏è for Students | StudentFocus ¬© 2024</footer>
    </section>

    <!-- EDIT MODAL -->
    <div id="edit-modal" class="modal-overlay hidden">
      <div class="modal">
        <h3><i class="fas fa-edit"></i> Edit Task</h3>
        <form id="edit-form">
          <input type="hidden" id="edit-id" />
          <div class="form-row">
            <input
              type="text"
              id="edit-title"
              placeholder="Task Title"
              required
            />
          </div>
          <div class="form-row">
            <input
              type="text"
              id="edit-subject"
              placeholder="Subject"
              required
            />
          </div>
          <div class="form-row">
            <select id="edit-category">
              <option value="Homework">Homework</option>
              <option value="Project">Project</option>
              <option value="Exam">Exam</option>
              <option value="Personal">Personal</option>
            </select>
            <select id="edit-priority">
              <option value="Low">Low</option>
              <option value="Medium">Medium</option>
              <option value="High">High</option>
            </select>
          </div>
          <div class="form-row">
            <input type="datetime-local" id="edit-due" required />
          </div>
          <div class="form-row">
            <input type="text" id="edit-notes" placeholder="Notes" />
          </div>
          <div class="modal-actions">
            <button type="button" id="cancel-edit" class="btn-secondary">
              Cancel
            </button>
            <button type="submit" class="btn-primary">Save Changes</button>
          </div>
        </form>
      </div>
    </div>

    <!-- FIREBASE SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <script>
      // =============================================
      // üî• FIREBASE CONFIGURATION
      // =============================================
      // Replace with your Firebase config
      const firebaseConfig = {
        apiKey: "AIzaSyBPpm5ttvLnQ9CcbvlSmd0DrKyxtmlEJJA",
        authDomain: "student-task-app-4d0ef.firebaseapp.com",
        databaseURL:
          "https://student-task-app-4d0ef-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "student-task-app-4d0ef",
        storageBucket: "student-task-app-4d0ef.firebasestorage.app",
        messagingSenderId: "458507771913",
        appId: "1:458507771913:web:699328c6aff9a61bba58d8",
      };

      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);
      const auth = firebase.auth();
      const db = firebase.database();

      // =============================================
      // üì¶ STATE MANAGEMENT
      // =============================================
      let currentUser = null;
      let tasks = [];
      let currentFilter = "all";
      let currentSort = "date-asc";
      let currentView = "pending";
      let searchQuery = "";
      let unsubscribe = null;

      // =============================================
      // üéØ DOM ELEMENTS
      // =============================================
      const authSection = document.getElementById("auth-section");
      const appSection = document.getElementById("app-section");
      const taskListEl = document.getElementById("task-list");
      const editModal = document.getElementById("edit-modal");

      // =============================================
      // üîê AUTHENTICATION
      // =============================================

      // Monitor Auth State
      auth.onAuthStateChanged((user) => {
        if (user) {
          currentUser = user;
          authSection.classList.add("hidden");
          appSection.classList.remove("hidden");

          // Get user name from database
          db.ref(`users/${user.uid}/name`)
            .once("value")
            .then((snapshot) => {
              const name = snapshot.val() || user.email.split("@")[0];
              document.getElementById("user-name").textContent = name;
            });

          loadTasks();
          showToast(`Welcome back! üëã`, "success");
        } else {
          currentUser = null;
          authSection.classList.remove("hidden");
          appSection.classList.add("hidden");
          tasks = [];
          if (unsubscribe) {
            unsubscribe();
            unsubscribe = null;
          }
        }
      });

      // Login
      document
        .getElementById("login-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const email = document.getElementById("login-email").value;
          const pass = document.getElementById("login-password").value;

          try {
            await auth.signInWithEmailAndPassword(email, pass);
          } catch (err) {
            showToast(getErrorMessage(err.code), "error");
          }
        });

      // Register
      document
        .getElementById("register-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const name = document.getElementById("reg-name").value;
          const email = document.getElementById("reg-email").value;
          const pass = document.getElementById("reg-password").value;

          try {
            const userCredential = await auth.createUserWithEmailAndPassword(
              email,
              pass,
            );
            // Save user name
            await db.ref(`users/${userCredential.user.uid}`).set({
              name: name,
              email: email,
              createdAt: Date.now(),
            });
            showToast(`Account created! Welcome ${name}! üéâ`, "success");
          } catch (err) {
            showToast(getErrorMessage(err.code), "error");
          }
        });

      // Logout
      document.getElementById("logout-btn").addEventListener("click", () => {
        auth.signOut();
        showToast("Logged out successfully", "success");
      });

      // Toggle Login/Register Tabs
      document
        .getElementById("tab-login")
        .addEventListener("click", () => toggleAuthTabs(true));
      document
        .getElementById("tab-register")
        .addEventListener("click", () => toggleAuthTabs(false));

      function toggleAuthTabs(isLogin) {
        document
          .getElementById("tab-login")
          .classList.toggle("active", isLogin);
        document
          .getElementById("tab-register")
          .classList.toggle("active", !isLogin);
        document
          .getElementById("login-form")
          .classList.toggle("hidden", !isLogin);
        document
          .getElementById("register-form")
          .classList.toggle("hidden", isLogin);
      }

      function getErrorMessage(code) {
        const messages = {
          "auth/email-already-in-use": "Email already registered!",
          "auth/invalid-email": "Invalid email address!",
          "auth/weak-password": "Password too weak (min 6 chars)!",
          "auth/user-not-found": "User not found!",
          "auth/wrong-password": "Incorrect password!",
          "auth/too-many-requests": "Too many attempts. Try later!",
        };
        return messages[code] || "An error occurred. Please try again.";
      }

      // =============================================
      // üìã TASK MANAGEMENT (REALTIME DATABASE)
      // =============================================

      // Load Tasks with Real-time Listener
      function loadTasks() {
        const tasksRef = db.ref(`tasks/${currentUser.uid}`);

        unsubscribe = tasksRef.on("value", (snapshot) => {
          tasks = [];
          snapshot.forEach((child) => {
            tasks.push({ id: child.key, ...child.val() });
          });
          renderTasks();
          updateStats();
        });
      }

      // Add Task
      document
        .getElementById("task-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const task = {
            title: document.getElementById("task-title").value,
            subject: document.getElementById("task-subject").value,
            category: document.getElementById("task-category").value,
            priority: document.getElementById("task-priority").value,
            dueDate: document.getElementById("task-due").value,
            notes: document.getElementById("task-notes").value,
            completed: false,
            createdAt: Date.now(),
          };

          try {
            await db.ref(`tasks/${currentUser.uid}`).push(task);
            document.getElementById("task-form").reset();
            document.getElementById("task-form").classList.add("hidden");
            showToast("Task added successfully! ‚úÖ", "success");
          } catch (err) {
            showToast("Error adding task!", "error");
          }
        });

      // Toggle Complete
      window.toggleComplete = async (id, currentStatus) => {
        try {
          await db.ref(`tasks/${currentUser.uid}/${id}`).update({
            completed: !currentStatus,
            completedAt: !currentStatus ? Date.now() : null,
          });
          showToast(
            currentStatus ? "Task reopened!" : "Task completed! üéâ",
            "success",
          );
        } catch (err) {
          showToast("Error updating task!", "error");
        }
      };

      // Delete Task
      window.deleteTask = async (id) => {
        if (confirm("üóëÔ∏è Delete this task?")) {
          try {
            await db.ref(`tasks/${currentUser.uid}/${id}`).remove();
            showToast("Task deleted!", "success");
          } catch (err) {
            showToast("Error deleting task!", "error");
          }
        }
      };

      // Edit Task
      window.editTask = (id) => {
        const task = tasks.find((t) => t.id === id);
        if (!task) return;

        document.getElementById("edit-id").value = id;
        document.getElementById("edit-title").value = task.title;
        document.getElementById("edit-subject").value = task.subject;
        document.getElementById("edit-category").value = task.category;
        document.getElementById("edit-priority").value = task.priority;
        document.getElementById("edit-due").value = task.dueDate;
        document.getElementById("edit-notes").value = task.notes || "";

        editModal.classList.remove("hidden");
      };

      // Save Edit
      document
        .getElementById("edit-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const id = document.getElementById("edit-id").value;
          const updates = {
            title: document.getElementById("edit-title").value,
            subject: document.getElementById("edit-subject").value,
            category: document.getElementById("edit-category").value,
            priority: document.getElementById("edit-priority").value,
            dueDate: document.getElementById("edit-due").value,
            notes: document.getElementById("edit-notes").value,
            updatedAt: Date.now(),
          };

          try {
            await db.ref(`tasks/${currentUser.uid}/${id}`).update(updates);
            editModal.classList.add("hidden");
            showToast("Task updated! ‚úÖ", "success");
          } catch (err) {
            showToast("Error updating task!", "error");
          }
        });

      // Cancel Edit
      document.getElementById("cancel-edit").addEventListener("click", () => {
        editModal.classList.add("hidden");
      });

      // Close modal on overlay click
      editModal.addEventListener("click", (e) => {
        if (e.target === editModal) editModal.classList.add("hidden");
      });

      // =============================================
      // üé® UI RENDERING
      // =============================================

      function renderTasks() {
        taskListEl.innerHTML = "";

        // Filter
        let filtered = tasks.filter((t) => {
          const matchesCat =
            currentFilter === "all" || t.category === currentFilter;
          const matchesSearch =
            searchQuery === "" ||
            t.title.toLowerCase().includes(searchQuery.toLowerCase()) ||
            t.subject.toLowerCase().includes(searchQuery.toLowerCase());

          let matchesView = true;
          if (currentView === "completed") matchesView = t.completed;
          else if (currentView === "pending") matchesView = !t.completed;

          return matchesCat && matchesView && matchesSearch;
        });

        // Sort
        filtered.sort((a, b) => {
          if (currentSort === "priority") {
            const map = { High: 3, Medium: 2, Low: 1 };
            return map[b.priority] - map[a.priority];
          } else if (currentSort === "date-asc") {
            return new Date(a.dueDate) - new Date(b.dueDate);
          } else if (currentSort === "date-desc") {
            return new Date(b.dueDate) - new Date(a.dueDate);
          } else {
            return b.createdAt - a.createdAt;
          }
        });

        if (filtered.length === 0) {
          taskListEl.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-tasks"></i>
                        <h3>No tasks found</h3>
                        <p>Time to relax or add a new task! üéâ</p>
                    </div>
                `;
          return;
        }

        const now = new Date();
        const categoryIcons = {
          Homework: "üìù",
          Project: "üíº",
          Exam: "üìñ",
          Personal: "üë§",
        };

        filtered.forEach((task) => {
          const due = new Date(task.dueDate);
          const isOverdue = due < now && !task.completed;
          const timeLeft = Math.ceil((due - now) / (1000 * 60 * 60 * 24));

          let dueBadge = "";
          if (isOverdue) {
            dueBadge = `<span class="badge badge-danger">‚ö†Ô∏è Overdue</span>`;
          } else if (timeLeft <= 1 && !task.completed) {
            dueBadge = `<span class="badge badge-warning">üî• Due Soon</span>`;
          } else if (timeLeft <= 3 && !task.completed) {
            dueBadge = `<span class="badge" style="background: var(--warning); color: #333;">‚è∞ ${timeLeft} days</span>`;
          }

          const div = document.createElement("div");
          div.className = `task-card priority-${task.priority} ${isOverdue ? "overdue" : ""} ${task.completed ? "completed" : ""}`;
          div.innerHTML = `
                    <div class="task-info">
                        <h4>${task.title} <span style="font-size:0.8em; font-weight:400; color:var(--text-light)">(${task.subject})</span></h4>
                        <div class="task-meta">
                            <span class="badge">${categoryIcons[task.category] || "üìÅ"} ${task.category}</span>
                            <span><i class="far fa-clock"></i> ${due.toLocaleDateString()} ${due.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" })}</span>
                            ${dueBadge}
                        </div>
                        ${task.notes ? `<small style="display:block; margin-top:8px; color:var(--text-light)">üìù ${task.notes}</small>` : ""}
                    </div>
                    <div class="task-actions">
                        <button class="check-btn" onclick="toggleComplete('${task.id}', ${task.completed})" title="${task.completed ? "Reopen" : "Complete"}">
                            <i class="fas ${task.completed ? "fa-undo" : "fa-check"}"></i>
                        </button>
                        <button class="edit-btn" onclick="editTask('${task.id}')" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="delete-btn" onclick="deleteTask('${task.id}')" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
          taskListEl.appendChild(div);
        });
      }

      function updateStats() {
        const total = tasks.length;
        const completed = tasks.filter((t) => t.completed).length;
        const pending = total - completed;
        const perc = total === 0 ? 0 : Math.round((completed / total) * 100);

        const now = new Date();
        const tomorrow = new Date(now.getTime() + 24 * 60 * 60 * 1000);
        const dueSoon = tasks.filter(
          (t) => !t.completed && new Date(t.dueDate) < tomorrow,
        ).length;

        document.getElementById("progress-fill").style.width = `${perc}%`;
        document.getElementById("progress-text").textContent = `${perc}%`;
        document.getElementById("total-count").textContent = total;
        document.getElementById("pending-count").textContent = pending;
        document.getElementById("due-soon-count").textContent = dueSoon;
      }

      // =============================================
      // üéõÔ∏è EVENT LISTENERS
      // =============================================

      // View Toggle
      document.querySelectorAll(".list-tab").forEach((btn) => {
        btn.addEventListener("click", (e) => {
          document
            .querySelectorAll(".list-tab")
            .forEach((b) => b.classList.remove("active"));
          e.target.classList.add("active");
          currentView = e.target.dataset.view;
          renderTasks();
        });
      });

      // Filters & Sort
      document
        .getElementById("filter-category")
        .addEventListener("change", (e) => {
          currentFilter = e.target.value;
          renderTasks();
        });

      document.getElementById("sort-tasks").addEventListener("change", (e) => {
        currentSort = e.target.value;
        renderTasks();
      });

      // Search
      document.getElementById("search-input").addEventListener("input", (e) => {
        searchQuery = e.target.value;
        renderTasks();
      });

      // Theme Toggle
      document.getElementById("theme-toggle").addEventListener("click", () => {
        const body = document.body;
        const icon = document.querySelector("#theme-toggle i");

        if (body.getAttribute("data-theme") === "dark") {
          body.removeAttribute("data-theme");
          icon.className = "fas fa-moon";
          localStorage.setItem("theme", "light");
        } else {
          body.setAttribute("data-theme", "dark");
          icon.className = "fas fa-sun";
          localStorage.setItem("theme", "dark");
        }
      });

      // Load saved theme
      if (localStorage.getItem("theme") === "dark") {
        document.body.setAttribute("data-theme", "dark");
        document.querySelector("#theme-toggle i").className = "fas fa-sun";
      }

      // Toggle Add Form
      document
        .getElementById("toggle-form-btn")
        .addEventListener("click", () => {
          document.getElementById("task-form").classList.toggle("hidden");
        });

      document
        .getElementById("close-form-btn")
        .addEventListener("click", () => {
          document.getElementById("task-form").classList.add("hidden");
        });

      // Export CSV
      document.getElementById("export-btn").addEventListener("click", () => {
        if (tasks.length === 0) {
          return showToast("No data to export!", "error");
        }

        let csvContent =
          "data:text/csv;charset=utf-8,Title,Subject,Category,Priority,Due Date,Status,Notes\n";
        tasks.forEach((t) => {
          const row = `"${t.title}","${t.subject}","${t.category}","${t.priority}","${t.dueDate}","${t.completed ? "Done" : "Pending"}","${t.notes || ""}"`;
          csvContent += row + "\n";
        });

        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute(
          "download",
          `studentfocus_tasks_${new Date().toISOString().split("T")[0]}.csv`,
        );
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        showToast("Tasks exported! üìÑ", "success");
      });

      // =============================================
      // üîî TOAST NOTIFICATIONS
      // =============================================
      function showToast(msg, type = "info") {
        const container = document.getElementById("toast-container");
        const toast = document.createElement("div");
        toast.className = `toast ${type}`;

        const icons = {
          success: "fa-check-circle",
          error: "fa-exclamation-circle",
          info: "fa-info-circle",
        };

        toast.innerHTML = `<i class="fas ${icons[type] || icons.info}"></i> ${msg}`;
        container.appendChild(toast);

        setTimeout(() => {
          toast.style.animation = "slideIn 0.3s ease reverse";
          setTimeout(() => toast.remove(), 300);
        }, 3000);
      }

      // =============================================
      // ‚å®Ô∏è KEYBOARD SHORTCUTS
      // =============================================
      document.addEventListener("keydown", (e) => {
        // Escape to close modals
        if (e.key === "Escape") {
          editModal.classList.add("hidden");
          document.getElementById("task-form").classList.add("hidden");
        }
        // Ctrl+N for new task
        if (e.ctrlKey && e.key === "n" && currentUser) {
          e.preventDefault();
          document.getElementById("task-form").classList.remove("hidden");
          document.getElementById("task-title").focus();
        }
      });
    </script>
  </body>
</html>
