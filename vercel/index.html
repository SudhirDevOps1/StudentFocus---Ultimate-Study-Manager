<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>StudentFocus | Ultimate Study Manager</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      /* :root {
        --primary: #6c63ff;
        --primary-dark: #5a52d9;
        --primary-light: #8b85ff;
        --secondary: #4a47a3;
        --accent: #00d4aa;
        --bg: #f0f2f5;
        --card-bg: #ffffff;
        --text: #2d3436;
        --text-light: #636e72;
        --border: #e1e5eb;
        --danger: #ff6b6b;
        --warning: #feca57;
        --success: #00d4aa;
        --info: #54a0ff;
        --high-prio: #ff7675;
        --med-prio: #fdcb6e;
        --low-prio: #00d4aa;
        --shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        --shadow-lg: 0 10px 40px rgba(0, 0, 0, 0.12);
        --gradient: linear-gradient(135deg, #6c63ff 0%, #4ecdc4 100%);
        --gradient-warm: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        --gradient-cool: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      }

      [data-theme="dark"] {
        --bg: #0a0a0f;
        --card-bg: #16161f;
        --text: #eceff4;
        --text-light: #9ca3af;
        --border: #2d2d3a;
        --shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        --shadow-lg: 0 10px 40px rgba(0, 0, 0, 0.6);
      } */

      /* :root {
    --primary: #7C3AED;
    --primary-dark: #5B21B6;
    --primary-light: #A78BFA;
    --secondary: #EC4899;
    --accent: #06D6A0;
    --bg: #F8FAFC;
    --card-bg: #ffffff;
    --text: #1E293B;
    --text-light: #64748B;
    --border: #E2E8F0;
    --danger: #EF4444;
    --warning: #F59E0B;
    --success: #10B981;
    --info: #3B82F6;
    --high-prio: #F43F5E;
    --med-prio: #FB923C;
    --low-prio: #22C55E;
    --shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    --shadow-lg: 0 10px 40px rgba(0, 0, 0, 0.12);
    --gradient: linear-gradient(135deg, #7C3AED 0%, #06D6A0 100%);
    --gradient-warm: linear-gradient(135deg, #EC4899 0%, #F43F5E 100%);
    --gradient-cool: linear-gradient(135deg, #3B82F6 0%, #06B6D4 100%);
}

[data-theme="dark"] {
    --bg: #0F172A;
    --card-bg: #1E293B;
    --text: #F1F5F9;
    --text-light: #94A3B8;
    --border: #334155;
    --shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
    --shadow-lg: 0 10px 40px rgba(0, 0, 0, 0.6);
} */

      :root {
        --primary: #6c63ff;
        --primary-dark: #5b45d9;
        --primary-light: #9d8aff;
        --secondary: #ff61dc;
        --accent: #00d4aa;
        --bg: #f4f6fc;
        --card-bg: #ffffff;
        --text: #14142b;
        --text-light: #6e7191;
        --border: #d9dbe9;
        --danger: #ff5c72;
        --warning: #ffb800;
        --success: #00c48c;
        --info: #00a3ff;
        --high-prio: #ff6480;
        --med-prio: #ffa94d;
        --low-prio: #38e8b0;
        --shadow: 0 4px 20px rgba(108, 99, 255, 0.15);
        --shadow-lg: 0 10px 40px rgba(108, 99, 255, 0.22);
        --gradient: linear-gradient(135deg, #6c63ff 0%, #4ecdc4 100%);
        --gradient-warm: linear-gradient(135deg, #ff61dc 0%, #ffb347 100%);
        --gradient-cool: linear-gradient(135deg, #00a3ff 0%, #00f0ff 100%);
      }

      [data-theme="dark"] {
        --bg: #07070f;
        --card-bg: #121220;
        --text: #fcfcfc;
        --text-light: #a0a3bd;
        --border: #262638;
        --shadow: 0 4px 20px rgba(0, 0, 0, 0.65);
        --shadow-lg: 0 10px 40px rgba(123, 97, 255, 0.28);
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Poppins", sans-serif;
      }

      body {
        background-color: var(--bg);
        color: var(--text);
        min-height: 100vh;
        transition: all 0.3s ease;
      }

      ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }

      ::-webkit-scrollbar-track {
        background: var(--bg);
      }

      ::-webkit-scrollbar-thumb {
        background: var(--primary);
        border-radius: 4px;
      }

      .hidden {
        display: none !important;
      }

      .btn-primary {
        background: var(--gradient);
        color: white;
        border: none;
        padding: 12px 28px;
        border-radius: 12px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(108, 99, 255, 0.4);
      }

      .btn-primary:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(108, 99, 255, 0.5);
      }

      .btn-secondary {
        background: transparent;
        border: 2px solid var(--primary);
        color: var(--primary);
        padding: 10px 24px;
        border-radius: 12px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
      }

      .btn-secondary:hover {
        background: var(--primary);
        color: white;
      }

      .btn-icon {
        background: var(--card-bg);
        border: 2px solid var(--border);
        padding: 10px 14px;
        border-radius: 12px;
        cursor: pointer;
        color: var(--text);
        transition: all 0.3s ease;
      }

      .btn-icon:hover {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
      }

      .highlight {
        color: var(--primary);
      }

      .danger-text {
        color: var(--danger);
        font-weight: bold;
      }

      .success-text {
        color: var(--success);
        font-weight: bold;
      }

      /* Auth Section */
      #auth-section {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        background: var(--gradient);
        padding: 20px;
        position: relative;
        overflow: hidden;
      }

      #auth-section::before {
        content: "";
        position: absolute;
        width: 400px;
        height: 400px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 50%;
        top: -100px;
        right: -100px;
      }

      #auth-section::after {
        content: "";
        position: absolute;
        width: 300px;
        height: 300px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 50%;
        bottom: -50px;
        left: -50px;
      }

      .auth-container {
        background: var(--card-bg);
        padding: 3rem;
        border-radius: 24px;
        box-shadow: var(--shadow-lg);
        width: 100%;
        max-width: 440px;
        text-align: center;
        animation: slideUp 0.6s ease;
        position: relative;
        z-index: 1;
      }

      @keyframes slideUp {
        from {
          opacity: 0;
          transform: translateY(40px);
        }

        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .auth-container .logo-icon {
        font-size: 3rem;
        margin-bottom: 1rem;
        background: var(--gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .auth-container h1 {
        font-size: 2.2rem;
        margin-bottom: 0.5rem;
        font-weight: 700;
      }

      .auth-container > p {
        color: var(--text-light);
        margin-bottom: 2rem;
      }

      .auth-tabs {
        display: flex;
        margin: 1.5rem 0;
        background: var(--bg);
        border-radius: 14px;
        padding: 5px;
      }

      .auth-tabs button {
        flex: 1;
        background: none;
        border: none;
        padding: 14px;
        cursor: pointer;
        color: var(--text-light);
        border-radius: 10px;
        font-weight: 500;
        transition: all 0.3s ease;
      }

      .auth-tabs button.active {
        background: var(--gradient);
        color: white;
        font-weight: 600;
      }

      .auth-container form {
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }

      .auth-container input {
        padding: 16px 20px;
        border-radius: 14px;
        border: 2px solid var(--border);
        background: var(--bg);
        color: var(--text);
        font-size: 1rem;
        transition: all 0.3s ease;
      }

      .auth-container input:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 4px rgba(108, 99, 255, 0.1);
      }

      /* App Header */
      header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem 3%;
        background: var(--card-bg);
        box-shadow: var(--shadow);
        position: sticky;
        top: 0;
        z-index: 100;
      }

      .logo {
        font-size: 1.6rem;
        font-weight: 800;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .logo i {
        background: var(--gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .header-controls {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .header-controls button {
        background: var(--bg);
        border: none;
        font-size: 1.1rem;
        padding: 12px 14px;
        border-radius: 12px;
        cursor: pointer;
        color: var(--text);
        transition: all 0.3s ease;
      }

      .header-controls button:hover {
        background: var(--primary);
        color: white;
      }

      .user-badge {
        background: var(--bg);
        padding: 10px 18px;
        border-radius: 25px;
        font-size: 0.9rem;
        color: var(--text);
        display: flex;
        align-items: center;
        gap: 10px;
        font-weight: 500;
      }

      .user-badge i {
        color: var(--primary);
      }

      .streak-badge {
        background: var(--gradient-warm);
        color: white;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      /* Navigation Tabs */
      .nav-tabs {
        display: flex;
        gap: 0.5rem;
        padding: 1rem 3%;
        background: var(--card-bg);
        border-bottom: 1px solid var(--border);
        overflow-x: auto;
      }

      .nav-tab {
        background: var(--bg);
        border: none;
        padding: 12px 24px;
        border-radius: 12px;
        cursor: pointer;
        font-weight: 500;
        color: var(--text-light);
        transition: all 0.3s ease;
        white-space: nowrap;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .nav-tab:hover {
        background: var(--border);
      }

      .nav-tab.active {
        background: var(--gradient);
        color: white;
      }

      /* Main Content */
      main {
        padding: 1.5rem 3%;
        max-width: 1600px;
        margin: 0 auto;
      }

      /* Dashboard Grid */
      .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 1.5rem;
        margin-bottom: 1.5rem;
      }

      /* Stat Cards */
      .stat-card {
        background: var(--card-bg);
        padding: 1.5rem;
        border-radius: 20px;
        box-shadow: var(--shadow);
        position: relative;
        overflow: hidden;
        transition: all 0.3s ease;
      }

      .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: var(--shadow-lg);
      }

      .stat-card::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 4px;
        background: var(--gradient);
      }

      .stat-card.gradient-warm::before {
        background: var(--gradient-warm);
      }

      .stat-card.gradient-cool::before {
        background: var(--gradient-cool);
      }

      .stat-card h3 {
        font-size: 0.9rem;
        color: var(--text-light);
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .stat-card .stat-value {
        font-size: 2.2rem;
        font-weight: 700;
        background: var(--gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .stat-card .stat-sub {
        font-size: 0.85rem;
        color: var(--text-light);
        margin-top: 0.5rem;
      }

      .progress-bar-bg {
        background: var(--border);
        height: 12px;
        border-radius: 6px;
        overflow: hidden;
        margin: 12px 0;
      }

      .progress-fill {
        background: var(--gradient);
        height: 100%;
        transition: width 0.5s ease;
        border-radius: 6px;
      }

      /* Pomodoro Timer */
      .pomodoro-container {
        background: var(--card-bg);
        border-radius: 24px;
        padding: 2rem;
        box-shadow: var(--shadow);
        text-align: center;
      }

      .pomodoro-timer {
        position: relative;
        width: 250px;
        height: 250px;
        margin: 0 auto 1.5rem;
      }

      .timer-circle {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        background: var(--bg);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        position: relative;
        box-shadow: inset 0 0 30px rgba(0, 0, 0, 0.1);
      }

      .timer-circle::before {
        content: "";
        position: absolute;
        width: 100%;
        height: 100%;
        border-radius: 50%;
        border: 8px solid var(--border);
      }

      .timer-progress {
        position: absolute;
        width: 100%;
        height: 100%;
        border-radius: 50%;
        border: 8px solid transparent;
        border-top-color: var(--primary);
        transform: rotate(-90deg);
        transition: transform 1s linear;
      }

      .timer-display {
        font-size: 3.5rem;
        font-weight: 700;
        background: var(--gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .timer-label {
        font-size: 1rem;
        color: var(--text-light);
        margin-top: 0.5rem;
      }

      .pomodoro-controls {
        display: flex;
        justify-content: center;
        gap: 1rem;
        margin-bottom: 1.5rem;
      }

      .pomodoro-btn {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        border: none;
        cursor: pointer;
        font-size: 1.3rem;
        transition: all 0.3s ease;
      }

      .pomodoro-btn.play {
        background: var(--gradient);
        color: white;
        box-shadow: 0 4px 20px rgba(108, 99, 255, 0.4);
      }

      .pomodoro-btn.play:hover {
        transform: scale(1.1);
      }

      .pomodoro-btn.reset {
        background: var(--bg);
        color: var(--text);
      }

      .pomodoro-stats {
        display: flex;
        justify-content: center;
        gap: 2rem;
        padding-top: 1rem;
        border-top: 1px solid var(--border);
      }

      .pomo-stat {
        text-align: center;
      }

      .pomo-stat span {
        display: block;
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--primary);
      }

      .pomo-stat small {
        color: var(--text-light);
        font-size: 0.8rem;
      }

      .timer-mode-tabs {
        display: flex;
        justify-content: center;
        gap: 0.5rem;
        margin-bottom: 1.5rem;
      }

      .mode-tab {
        padding: 8px 20px;
        border: none;
        background: var(--bg);
        border-radius: 20px;
        cursor: pointer;
        font-weight: 500;
        color: var(--text-light);
        transition: all 0.3s ease;
      }

      .mode-tab.active {
        background: var(--primary);
        color: white;
      }

      /* Study Time Tracker */
      .study-tracker {
        background: var(--card-bg);
        border-radius: 24px;
        padding: 2rem;
        box-shadow: var(--shadow);
      }

      .today-study {
        text-align: center;
        margin-bottom: 2rem;
      }

      .study-time-display {
        font-size: 3rem;
        font-weight: 700;
        background: var(--gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .study-goal-progress {
        margin-top: 1rem;
      }

      .goal-text {
        display: flex;
        justify-content: space-between;
        font-size: 0.9rem;
        color: var(--text-light);
        margin-bottom: 0.5rem;
      }

      .weekly-chart {
        display: flex;
        justify-content: space-between;
        align-items: flex-end;
        height: 150px;
        padding: 1rem 0;
        border-top: 1px solid var(--border);
      }

      .chart-bar {
        flex: 1;
        margin: 0 4px;
        background: var(--border);
        border-radius: 8px 8px 0 0;
        transition: all 0.3s ease;
        position: relative;
        min-height: 10px;
      }

      .chart-bar:hover {
        opacity: 0.8;
      }

      .chart-bar.active {
        background: var(--gradient);
      }

      .chart-bar span {
        position: absolute;
        bottom: -25px;
        left: 50%;
        transform: translateX(-50%);
        font-size: 0.75rem;
        color: var(--text-light);
      }

      /* Grades Section */
      .grades-container {
        background: var(--card-bg);
        border-radius: 24px;
        padding: 2rem;
        box-shadow: var(--shadow);
      }

      .gpa-display {
        text-align: center;
        padding: 2rem;
        background: var(--gradient);
        border-radius: 20px;
        color: white;
        margin-bottom: 2rem;
      }

      .gpa-value {
        font-size: 4rem;
        font-weight: 800;
      }

      .gpa-label {
        font-size: 1.1rem;
        opacity: 0.9;
      }

      .grade-form {
        display: grid;
        grid-template-columns: 2fr 1fr 1fr 1fr auto;
        gap: 1rem;
        margin-bottom: 1.5rem;
        align-items: end;
      }

      .grade-form input,
      .grade-form select {
        padding: 12px 16px;
        border-radius: 12px;
        border: 2px solid var(--border);
        background: var(--bg);
        color: var(--text);
        font-size: 0.95rem;
      }

      .grade-form input:focus,
      .grade-form select:focus {
        outline: none;
        border-color: var(--primary);
      }

      .grade-form label {
        display: block;
        font-size: 0.85rem;
        color: var(--text-light);
        margin-bottom: 0.5rem;
      }

      .grades-list {
        max-height: 400px;
        overflow-y: auto;
      }

      .grade-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem;
        background: var(--bg);
        border-radius: 12px;
        margin-bottom: 0.75rem;
        transition: all 0.3s ease;
      }

      .grade-item:hover {
        transform: translateX(5px);
      }

      .grade-info h4 {
        font-size: 1rem;
        margin-bottom: 4px;
      }

      .grade-info span {
        font-size: 0.85rem;
        color: var(--text-light);
      }

      .grade-score {
        font-size: 1.5rem;
        font-weight: 700;
        padding: 8px 16px;
        border-radius: 12px;
      }

      .grade-A {
        background: #d4edda;
        color: #155724;
      }

      .grade-B {
        background: #cce5ff;
        color: #004085;
      }

      .grade-C {
        background: #fff3cd;
        color: #856404;
      }

      .grade-D {
        background: #ffe5d0;
        color: #8a4500;
      }

      .grade-F {
        background: #f8d7da;
        color: #721c24;
      }

      /* Achievements */
      .achievements-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 1rem;
      }

      .achievement-card {
        background: var(--card-bg);
        border-radius: 16px;
        padding: 1.5rem;
        text-align: center;
        box-shadow: var(--shadow);
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
      }

      .achievement-card:hover {
        transform: translateY(-5px);
      }

      .achievement-card.locked {
        opacity: 0.5;
        filter: grayscale(1);
      }

      .achievement-card.locked::after {
        content: "ðŸ”’";
        position: absolute;
        top: 10px;
        right: 10px;
        font-size: 1.2rem;
      }

      .achievement-icon {
        font-size: 2.5rem;
        margin-bottom: 0.75rem;
      }

      .achievement-card h4 {
        font-size: 0.9rem;
        margin-bottom: 0.25rem;
      }

      .achievement-card p {
        font-size: 0.75rem;
        color: var(--text-light);
      }

      /* Search & Controls */
      .search-container {
        margin-bottom: 1rem;
      }

      .search-box {
        display: flex;
        align-items: center;
        background: var(--card-bg);
        border-radius: 14px;
        padding: 14px 20px;
        box-shadow: var(--shadow);
        gap: 12px;
      }

      .search-box i {
        color: var(--text-light);
      }

      .search-box input {
        flex: 1;
        border: none;
        background: transparent;
        font-size: 1rem;
        color: var(--text);
        outline: none;
      }

      .controls-container {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
        gap: 1rem;
        align-items: center;
        margin-bottom: 1.5rem;
      }

      .filters {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
      }

      select {
        padding: 12px 18px;
        border-radius: 12px;
        border: 2px solid var(--border);
        background: var(--card-bg);
        color: var(--text);
        cursor: pointer;
        font-weight: 500;
        transition: all 0.3s ease;
      }

      select:focus {
        outline: none;
        border-color: var(--primary);
      }

      /* Task Form */
      #task-form {
        background: var(--card-bg);
        padding: 1.5rem;
        border-radius: 20px;
        box-shadow: var(--shadow);
        margin-bottom: 1.5rem;
        animation: slideDown 0.3s ease;
      }

      @keyframes slideDown {
        from {
          opacity: 0;
          transform: translateY(-20px);
        }

        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .form-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
      }

      .form-header h3 {
        color: var(--primary);
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .form-row {
        display: flex;
        gap: 1rem;
        margin-bottom: 1rem;
      }

      .form-row > * {
        flex: 1;
        padding: 14px 18px;
        border-radius: 12px;
        border: 2px solid var(--border);
        background: var(--bg);
        color: var(--text);
        font-size: 0.95rem;
        transition: all 0.3s ease;
      }

      .form-row > *:focus {
        outline: none;
        border-color: var(--primary);
      }

      @media (max-width: 600px) {
        .form-row {
          flex-direction: column;
        }

        .grade-form {
          grid-template-columns: 1fr;
        }
      }

      /* Task Tabs */
      .list-tabs {
        display: flex;
        gap: 1rem;
        margin-bottom: 1rem;
      }

      .list-tab {
        background: var(--bg);
        border: none;
        font-size: 1rem;
        padding: 12px 24px;
        cursor: pointer;
        color: var(--text-light);
        border-radius: 12px;
        transition: all 0.3s ease;
        font-weight: 500;
      }

      .list-tab.active {
        background: var(--gradient);
        color: white;
      }

      /* Task List */
      .task-list {
        display: grid;
        gap: 1rem;
      }

      .task-card {
        background: var(--card-bg);
        padding: 1.25rem 1.5rem;
        border-radius: 16px;
        box-shadow: var(--shadow);
        border-left: 5px solid var(--border);
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: all 0.3s ease;
        animation: fadeIn 0.3s ease;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: scale(0.95);
        }

        to {
          opacity: 1;
          transform: scale(1);
        }
      }

      .task-card:hover {
        transform: translateX(5px);
        box-shadow: var(--shadow-lg);
      }

      .task-card.priority-High {
        border-left-color: var(--high-prio);
      }

      .task-card.priority-Medium {
        border-left-color: var(--med-prio);
      }

      .task-card.priority-Low {
        border-left-color: var(--low-prio);
      }

      .task-card.overdue {
        background: rgba(255, 107, 107, 0.1);
        border: 2px solid var(--danger);
        border-left-width: 5px;
      }

      .task-info {
        flex: 1;
      }

      .task-info h4 {
        margin-bottom: 6px;
        font-size: 1.1rem;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .task-meta {
        font-size: 0.85rem;
        color: var(--text-light);
        display: flex;
        gap: 12px;
        align-items: center;
        flex-wrap: wrap;
      }

      .badge {
        padding: 4px 12px;
        border-radius: 20px;
        background: var(--bg);
        font-size: 0.75rem;
        font-weight: 600;
      }

      .badge-danger {
        background: var(--danger);
        color: white;
      }

      .badge-warning {
        background: var(--warning);
        color: #333;
      }

      .badge-success {
        background: var(--success);
        color: white;
      }

      .task-actions {
        display: flex;
        gap: 8px;
      }

      .task-actions button {
        background: var(--bg);
        border: none;
        cursor: pointer;
        padding: 10px 12px;
        font-size: 1rem;
        color: var(--text-light);
        border-radius: 10px;
        transition: all 0.3s ease;
      }

      .task-actions button:hover {
        transform: scale(1.1);
      }

      .check-btn:hover {
        background: var(--success);
        color: white !important;
      }

      .edit-btn:hover {
        background: var(--primary);
        color: white !important;
      }

      .delete-btn:hover {
        background: var(--danger);
        color: white !important;
      }

      .task-card.completed {
        opacity: 0.6;
        background: var(--bg);
      }

      .task-card.completed h4 {
        text-decoration: line-through;
      }

      /* Calendar Styles */
      .calendar-container {
        background: var(--card-bg);
        border-radius: 12px;
        padding: 20px;
        box-shadow: var(--shadow);
      }

      .calendar-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .calendar-days-header {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        text-align: center;
        font-weight: bold;
        margin-bottom: 10px;
        color: var(--text-light);
      }

      .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 5px;
      }

      .calendar-day {
        aspect-ratio: 1;
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 5px;
        cursor: pointer;
        position: relative;
        transition: background 0.2s;
      }

      .calendar-day:hover {
        background: var(--bg);
      }

      .calendar-day.today {
        border-color: var(--primary);
        background: rgba(108, 99, 255, 0.1);
        font-weight: bold;
      }

      .calendar-day.selected {
        background: var(--primary);
        color: white;
      }

      .calendar-day.has-event::after {
        content: "";
        position: absolute;
        bottom: 5px;
        left: 50%;
        transform: translateX(-50%);
        width: 6px;
        height: 6px;
        background: var(--accent);
        border-radius: 50%;
      }

      .calendar-day.other-month {
        opacity: 0.5;
      }

      .calendar-task-preview {
        margin-top: 20px;
        padding-top: 15px;
        border-top: 1px solid var(--border);
      }

      /* Notes Section */
      .notes-container {
        background: var(--card-bg);
        border-radius: 24px;
        padding: 2rem;
        box-shadow: var(--shadow);
      }

      .notes-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
      }

      .note-card {
        background: var(--bg);
        border-radius: 16px;
        padding: 1.25rem;
        position: relative;
        transition: all 0.3s ease;
      }

      .note-card:hover {
        transform: translateY(-3px);
        box-shadow: var(--shadow);
      }

      .note-card.color-1 {
        border-top: 4px solid #ff6b6b;
      }

      .note-card.color-2 {
        border-top: 4px solid #feca57;
      }

      .note-card.color-3 {
        border-top: 4px solid #00d4aa;
      }

      .note-card.color-4 {
        border-top: 4px solid #54a0ff;
      }

      .note-card.color-5 {
        border-top: 4px solid #5f27cd;
      }

      .note-card h4 {
        font-size: 1rem;
        margin-bottom: 0.5rem;
      }

      .note-card p {
        font-size: 0.9rem;
        color: var(--text-light);
        line-height: 1.5;
      }

      .note-card .note-date {
        font-size: 0.75rem;
        color: var(--text-light);
        margin-top: 1rem;
      }

      .note-card .note-actions {
        position: absolute;
        top: 10px;
        right: 10px;
        display: flex;
        gap: 5px;
        opacity: 0;
        transition: opacity 0.3s ease;
      }

      .note-card:hover .note-actions {
        opacity: 1;
      }

      .note-actions button {
        background: var(--card-bg);
        border: none;
        padding: 6px 8px;
        border-radius: 6px;
        cursor: pointer;
        color: var(--text-light);
        font-size: 0.85rem;
      }

      /* Empty State */
      .empty-state {
        text-align: center;
        padding: 3rem;
        color: var(--text-light);
      }

      .empty-state i {
        font-size: 4rem;
        margin-bottom: 1rem;
        color: var(--border);
      }

      /* Toast */
      #toast-container {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 1000;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .toast {
        background: var(--card-bg);
        color: var(--text);
        padding: 16px 24px;
        border-radius: 14px;
        box-shadow: var(--shadow-lg);
        border-left: 4px solid var(--primary);
        animation: slideIn 0.3s ease;
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .toast.error {
        border-left-color: var(--danger);
      }

      .toast.success {
        border-left-color: var(--success);
      }

      .toast.warning {
        border-left-color: var(--warning);
      }

      @keyframes slideIn {
        from {
          transform: translateX(100%);
          opacity: 0;
        }

        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      /* Modal */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        animation: fadeIn 0.2s ease;
        backdrop-filter: blur(5px);
      }

      .modal {
        background: var(--card-bg);
        padding: 2rem;
        border-radius: 24px;
        width: 90%;
        max-width: 500px;
        box-shadow: var(--shadow-lg);
        animation: slideUp 0.3s ease;
      }

      .modal h3 {
        margin-bottom: 1.5rem;
        color: var(--primary);
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .modal-actions {
        display: flex;
        gap: 1rem;
        margin-top: 1.5rem;
        justify-content: flex-end;
      }

      /* Focus Mode Overlay */
      .focus-mode-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: var(--bg);
        z-index: 2000;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        animation: fadeIn 0.5s ease;
      }

      .focus-mode-content {
        text-align: center;
        max-width: 600px;
        padding: 2rem;
      }

      .focus-mode-timer {
        font-size: 8rem;
        font-weight: 800;
        background: var(--gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin: 2rem 0;
      }

      .focus-task-display {
        font-size: 1.5rem;
        color: var(--text-light);
        margin-bottom: 2rem;
      }

      .focus-quote {
        font-style: italic;
        color: var(--text-light);
        margin-top: 2rem;
        font-size: 1.1rem;
      }

      /* Calendar Mini */
      .calendar-mini {
        background: var(--card-bg);
        border-radius: 20px;
        padding: 1.5rem;
        box-shadow: var(--shadow);
      }

      .calendar-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
      }

      .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 5px;
        text-align: center;
      }

      .calendar-day-header {
        font-size: 0.75rem;
        color: var(--text-light);
        padding: 5px;
      }

      .calendar-day {
        padding: 8px;
        border-radius: 8px;
        font-size: 0.85rem;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .calendar-day:hover {
        background: var(--border);
      }

      .calendar-day.today {
        background: var(--gradient);
        color: white;
        font-weight: 600;
      }

      .calendar-day.has-task::after {
        content: "";
        display: block;
        width: 4px;
        height: 4px;
        background: var(--primary);
        border-radius: 50%;
        margin: 2px auto 0;
      }

      /* Responsive */
      @media (max-width: 768px) {
        .nav-tabs {
          flex-wrap: nowrap;
        }

        .pomodoro-timer {
          width: 200px;
          height: 200px;
        }

        .timer-display {
          font-size: 2.5rem;
        }

        .user-badge span {
          display: none;
        }

        .streak-badge span {
          display: none;
        }

        header {
          padding: 1rem 2%;
        }

        main {
          padding: 1rem 2%;
        }

        .gpa-value {
          font-size: 3rem;
        }
      }

      @media (max-width: 480px) {
        .controls-container {
          flex-direction: column;
          align-items: stretch;
        }

        .task-card {
          flex-direction: column;
          align-items: flex-start;
          gap: 1rem;
        }

        .task-actions {
          align-self: flex-end;
        }
      }

      /* Picture-in-Picture Window Styles */
      .pip-window {
        position: fixed;
        top: 20px;
        right: 20px;
        width: 300px;
        min-height: 200px;
        background: var(--card-bg);
        border: 1px solid var(--border);
        border-radius: 12px;
        box-shadow: var(--shadow-lg);
        z-index: 1000;
        display: flex;
        flex-direction: column;
        max-height: 70vh;
        resize: both;
        overflow: hidden;
      }

      .pip-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 16px;
        background: var(--primary);
        color: white;
        border-top-left-radius: 12px;
        border-top-right-radius: 12px;
      }

      .pip-controls {
        display: flex;
        gap: 8px;
      }

      .pip-btn {
        background: rgba(255, 255, 255, 0.2);
        border: none;
        color: white;
        width: 28px;
        height: 28px;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .pip-btn:hover {
        background: rgba(255, 255, 255, 0.3);
      }

      .pip-content {
        padding: 16px;
        overflow-y: auto;
        flex-grow: 1;
      }

      .pip-pomodoro {
        text-align: center;
      }

      .pip-controls-bottom {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin-top: 15px;
      }

      .pip-task-item {
        padding: 8px 0;
        border-bottom: 1px solid var(--border);
        cursor: pointer;
      }

      .pip-task-item:last-child {
        border-bottom: none;
      }

      .pip-task-title {
        font-weight: 500;
        font-size: 0.9em;
      }

      .pip-task-due {
        font-size: 0.8em;
        color: var(--text-light);
      }

      /* Music Player Styles */
      .music-player {
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 320px;
        background: var(--card-bg);
        border: 1px solid var(--border);
        border-radius: 16px;
        box-shadow: var(--shadow-lg);
        z-index: 999;
        overflow: hidden;
      }

      .music-player-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px;
        background: var(--primary);
        color: white;
        font-weight: 600;
      }

      .music-player-content {
        padding: 16px;
      }

      .now-playing {
        text-align: center;
        margin-bottom: 16px;
      }

      .track-info {
        margin: 10px 0;
      }

      #current-track {
        font-size: 1.1em;
        font-weight: 600;
        margin-bottom: 4px;
      }

      .artist {
        color: var(--text-light);
        font-size: 0.9em;
      }

      .progress-container {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 16px;
      }

      .progress-bar {
        flex-grow: 1;
        height: 4px;
        background: var(--border);
        border-radius: 2px;
        outline: none;
      }

      #current-time,
      #total-time {
        font-size: 0.8em;
        color: var(--text-light);
        width: 40px;
      }

      .controls {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 20px;
        margin-bottom: 16px;
      }

      .music-btn {
        background: var(--card-bg);
        border: 1px solid var(--border);
        width: 40px;
        height: 40px;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--text);
        transition: all 0.3s ease;
      }

      .music-btn:hover {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
      }

      .big-btn {
        width: 50px;
        height: 50px;
        font-size: 1.2em;
      }

      .volume-control {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 16px;
      }

      .volume-slider {
        flex-grow: 1;
        height: 4px;
        background: var(--border);
        border-radius: 2px;
        outline: none;
      }

      .playlist {
        max-height: 150px;
        overflow-y: auto;
        border-top: 1px solid var(--border);
        padding-top: 10px;
      }

      .track-item {
        padding: 8px;
        cursor: pointer;
        border-radius: 6px;
        margin-bottom: 4px;
      }

      .track-item:hover {
        background: var(--bg);
      }

      .track-item.active {
        background: var(--primary);
        color: white;
      }

      /* Analytics Section Styles */
      .analytics-section {
        margin-top: 30px;
        padding: 20px;
        background: var(--card-bg);
        border-radius: 12px;
        box-shadow: var(--shadow);
      }

      .analytics-section h3 {
        margin: 0 0 15px 0;
        color: var(--primary);
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .chart-container {
        margin-bottom: 25px;
      }

      .subject-item {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
        padding: 8px;
        background: var(--bg);
        border-radius: 8px;
      }

      .subject-name {
        width: 100px;
        font-weight: 500;
      }

      .subject-bar {
        flex-grow: 1;
        height: 20px;
        background: var(--primary);
        border-radius: 10px;
        margin: 0 10px;
        position: relative;
        overflow: hidden;
      }

      .subject-bar::after {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        height: 100%;
        width: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.3)
        );
      }

      .subject-time {
        width: 60px;
        text-align: right;
        color: var(--text-light);
      }

      .heatmap-container {
        margin-top: 15px;
      }

      .heatmap-grid {
        display: grid;
        grid-template-columns: 80px repeat(4, 20px);
        gap: 4px;
        margin-top: 10px;
      }

      .heatmap-cell {
        width: 20px;
        height: 20px;
        background: var(--bg);
        border-radius: 3px;
        position: relative;
      }

      .heatmap-header {
        font-size: 0.8em;
        display: flex;
        align-items: center;
        justify-content: center;
        background: transparent;
        color: var(--text-light);
      }

      .heatmap-day {
        font-size: 0.8em;
        display: flex;
        align-items: center;
        justify-content: center;
        background: transparent;
        color: var(--text-light);
      }

      .intensity-1 {
        background: #c6e48b;
      }

      .intensity-2 {
        background: #7bc96f;
      }

      .intensity-3 {
        background: #239a3b;
      }

      /* Pie Chart Styles */
      .chart-flex-container {
        display: flex;
        align-items: center;
        gap: 30px;
        margin-bottom: 25px;
        flex-wrap: wrap;
      }

      .pie-chart {
        width: 150px;
        height: 150px;
        border-radius: 50%;
        background: #e0e0e0;
        position: relative;
        flex-shrink: 0;
      }

      .chart-legend {
        flex-grow: 1;
      }

      .legend-item {
        display: flex;
        align-items: center;
        margin-bottom: 8px;
      }

      .legend-color {
        width: 12px;
        height: 12px;
        border-radius: 3px;
        margin-right: 8px;
      }

      .legend-text {
        font-size: 0.9em;
        color: var(--text);
      }

      /* Heatmap Styles */
      .heatmap-container {
        margin-top: 15px;
        overflow-x: auto;
      }

      .heatmap-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 5px;
        max-width: 300px;
      }

      .heatmap-cell {
        width: 100%;
        aspect-ratio: 1;
        background: var(--bg);
        border-radius: 4px;
        border: 1px solid var(--border);
      }

      .heatmap-header {
        text-align: center;
        font-size: 0.8em;
        color: var(--text-light);
        margin-bottom: 5px;
      }

      .intensity-0 {
        background: var(--bg);
      }

      .intensity-1 {
        background: #9be9a8;
      }

      .intensity-2 {
        background: #40c463;
      }

      .intensity-3 {
        background: #216e39;
      }

      /* Note Colors */
      .color-1 {
        background: #fee2e2;
        border-left: 5px solid #ef4444;
      }

      /* Red */
      .color-2 {
        background: #fef3c7;
        border-left: 5px solid #f59e0b;
      }

      /* Yellow */
      .color-3 {
        background: #d1fae5;
        border-left: 5px solid #10b981;
      }

      /* Green */
      .color-4 {
        background: #dbeafe;
        border-left: 5px solid #3b82f6;
      }

      /* Blue */
      .color-5 {
        background: #f3e8ff;
        border-left: 5px solid #a855f7;
      }

      /* Purple */

      /* Draggable Elements */
      .pip-header,
      .music-header {
        cursor: move;
      }
    </style>
  </head>

  <body>
    <!-- NOTIFICATIONS -->
    <div id="toast-container"></div>

    <!-- Picture-in-Picture Window (Hidden by default) -->
    <div id="pip-window" class="pip-window hidden">
      <div class="pip-header">
        <span id="pip-title">Floating Task</span>
        <div class="pip-controls">
          <button id="pip-minimize" class="pip-btn">
            <i class="fas fa-minus"></i>
          </button>
          <button id="pip-close" class="pip-btn">
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>
      <div id="pip-content" class="pip-content">
        <!-- Content will be dynamically populated -->
        <div id="pip-task-list"></div>
        <div id="pip-pomodoro" class="pip-pomodoro">
          <div class="timer-display" id="pip-timer">25:00</div>
          <div class="pip-controls-bottom">
            <button id="pip-start-stop" class="btn-icon">
              <i class="fas fa-play"></i>
            </button>
            <button id="pip-reset" class="btn-icon">
              <i class="fas fa-redo"></i>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Music Player (Hidden by default) -->
    <div id="music-player" class="music-player hidden">
      <div class="music-player-header">
        <i class="fas fa-music"></i> Focus Music
        <div style="margin-left: auto; display: flex; gap: 5px">
          <button id="music-pip-btn" class="music-btn" title="Pop out player">
            <i class="fas fa-external-link-alt"></i>
          </button>
          <button id="close-music" class="music-btn">
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>
      <div class="music-player-content">
        <div class="now-playing">
          <div class="track-info">
            <div id="current-track">Select a track</div>
            <div id="current-artist" class="artist">StudentFocus Player</div>
          </div>
        </div>
        <div class="progress-container">
          <span id="current-time">0:00</span>
          <input
            type="range"
            id="progress-bar"
            class="progress-bar"
            value="0"
          />
          <span id="total-time">0:00</span>
        </div>
        <div class="controls">
          <button id="prev-track" class="music-btn">
            <i class="fas fa-step-backward"></i>
          </button>
          <button id="play-pause" class="music-btn big-btn">
            <i class="fas fa-play"></i>
          </button>
          <button id="next-track" class="music-btn">
            <i class="fas fa-step-forward"></i>
          </button>
        </div>
        <div class="volume-control">
          <i class="fas fa-volume-up"></i>
          <input
            type="range"
            id="volume-slider"
            class="volume-slider"
            min="0"
            max="1"
            step="0.01"
            value="0.7"
          />
        </div>
        <div class="playlist">
          <div id="tracks-list"></div>
        </div>
      </div>
    </div>

    <!-- Hidden audio element -->
    <audio id="audio-player" preload="metadata"></audio>

    <!-- AUTH SECTION -->
    <section id="auth-section" class="active-section">
      <div class="auth-container">
        <div class="logo-icon"><i class="fas fa-graduation-cap"></i></div>
        <h1>Student<span class="highlight">Focus</span></h1>
        <p>ðŸ“š Your ultimate study companion</p>

        <div class="auth-tabs">
          <button id="tab-login" class="active">Login</button>
          <button id="tab-register">Sign Up</button>
        </div>

        <form id="login-form">
          <input
            type="email"
            id="login-email"
            placeholder="ðŸ“§ Email"
            required
          />
          <input
            type="password"
            id="login-password"
            placeholder="ðŸ”’ Password"
            required
          />
          <button type="submit" class="btn-primary">
            <i class="fas fa-sign-in-alt"></i> Login
          </button>
        </form>

        <form id="register-form" class="hidden">
          <input
            type="text"
            id="reg-name"
            placeholder="ðŸ‘¤ Full Name"
            required
          />
          <input type="email" id="reg-email" placeholder="ðŸ“§ Email" required />
          <input
            type="password"
            id="reg-password"
            placeholder="ðŸ”’ Password (6+ chars)"
            required
          />
          <button type="submit" class="btn-primary">
            <i class="fas fa-user-plus"></i> Create Account
          </button>
        </form>
      </div>
    </section>

    <!-- APP SECTION -->
    <section id="app-section" class="hidden">
      <header>
        <div class="logo">
          <i class="fas fa-graduation-cap"></i>
          Student<span class="highlight">Focus</span>
        </div>
        <div class="header-controls">
          <div class="streak-badge" id="streak-badge" title="Study Streak">
            <i class="fas fa-fire"></i>
            <span id="streak-count">0</span> days
          </div>
          <div class="user-badge" id="user-badge">
            <i class="fas fa-user-circle"></i>
            <span id="user-name">User</span>
          </div>
          <button id="focus-mode-btn" title="Focus Mode">
            <i class="fas fa-bullseye"></i>
          </button>
          <button
            id="pip-toggle-btn"
            title="PiP Mode (Ctrl+P)"
            onclick="togglePipWindow()"
          >
            <i class="fas fa-external-link-square-alt"></i>
          </button>
          <button
            id="music-toggle-btn"
            title="Music Player (Ctrl+M)"
            onclick="toggleMusicPlayer()"
          >
            <i class="fas fa-music"></i>
          </button>
          <button id="theme-toggle" title="Toggle Theme">
            <i class="fas fa-moon"></i>
          </button>
          <button id="logout-btn" title="Logout">
            <i class="fas fa-sign-out-alt"></i>
          </button>
        </div>
      </header>

      <!-- Navigation -->
      <nav class="nav-tabs">
        <button class="nav-tab active" data-section="dashboard">
          <i class="fas fa-home"></i> Dashboard
        </button>
        <button class="nav-tab" data-section="tasks">
          <i class="fas fa-tasks"></i> Tasks
        </button>
        <button class="nav-tab" data-section="pomodoro">
          <i class="fas fa-clock"></i> Pomodoro
        </button>
        <button class="nav-tab" data-section="grades">
          <i class="fas fa-chart-line"></i> Grades
        </button>
        <button class="nav-tab" data-section="notes">
          <i class="fas fa-sticky-note"></i> Notes
        </button>
        <button class="nav-tab" data-section="achievements">
          <i class="fas fa-trophy"></i> Achievements
        </button>
      </nav>

      <main>
        <!-- DASHBOARD SECTION -->
        <div id="section-dashboard" class="section-content">
          <div class="dashboard-grid">
            <!-- Progress -->
            <div class="stat-card">
              <h3><i class="fas fa-chart-pie"></i> Task Progress</h3>
              <div class="progress-bar-bg">
                <div
                  id="progress-fill"
                  class="progress-fill"
                  style="width: 0%"
                ></div>
              </div>
              <div class="stat-value" id="progress-text">0%</div>
              <div class="stat-sub">Tasks completed</div>
            </div>

            <!-- Study Time Today -->
            <div class="stat-card gradient-warm">
              <h3><i class="fas fa-book-reader"></i> Study Time Today</h3>
              <div class="stat-value" id="today-study-time">0h 0m</div>
              <div class="stat-sub">
                Goal: <span id="daily-goal-display">2h</span>
              </div>
              <div class="progress-bar-bg">
                <div
                  id="study-goal-fill"
                  class="progress-fill"
                  style="width: 0%"
                ></div>
              </div>
            </div>

            <!-- Total Tasks -->
            <div class="stat-card">
              <h3><i class="fas fa-list-check"></i> Total Tasks</h3>
              <div class="stat-value" id="total-count">0</div>
              <div class="stat-sub">
                <span id="pending-count">0</span> pending
              </div>
            </div>

            <!-- Due Soon -->
            <div class="stat-card gradient-cool">
              <h3><i class="fas fa-exclamation-triangle"></i> Due Soon</h3>
              <div class="stat-value danger-text" id="due-soon-count">0</div>
              <div class="stat-sub">Within 24 hours</div>
            </div>

            <!-- GPA -->
            <div class="stat-card">
              <h3><i class="fas fa-award"></i> Current GPA</h3>
              <div class="stat-value" id="current-gpa">0.00</div>
              <div class="stat-sub">
                Based on <span id="grade-count">0</span> grades
              </div>
            </div>

            <!-- Pomodoro Sessions -->
            <div class="stat-card gradient-warm">
              <h3><i class="fas fa-stopwatch"></i> Focus Sessions</h3>
              <div class="stat-value" id="pomo-today">0</div>
              <div class="stat-sub">Pomodoros today</div>
            </div>
          </div>

          <!-- Weekly Study Chart -->
          <div class="study-tracker">
            <h3 style="margin-bottom: 1rem">
              <i class="fas fa-chart-bar"></i> Weekly Study Hours
            </h3>
            <div class="weekly-chart" id="weekly-chart">
              <div class="chart-bar" style="height: 20%"><span>Mon</span></div>
              <div class="chart-bar" style="height: 40%"><span>Tue</span></div>
              <div class="chart-bar" style="height: 60%"><span>Wed</span></div>
              <div class="chart-bar" style="height: 30%"><span>Thu</span></div>
              <div class="chart-bar" style="height: 80%"><span>Fri</span></div>
              <div class="chart-bar" style="height: 50%"><span>Sat</span></div>
              <div class="chart-bar active" style="height: 45%">
                <span>Sun</span>
              </div>
            </div>
          </div>

          <!-- Quick Actions -->
          <div
            style="
              display: flex;
              gap: 1rem;
              margin-top: 1.5rem;
              flex-wrap: wrap;
            "
          >
            <button
              class="btn-primary"
              onclick="
                showSection('tasks');
                setTimeout(() => {
                  document
                    .getElementById('task-form')
                    .classList.remove('hidden');
                }, 10);
              "
            >
              <i class="fas fa-plus"></i> Add Task
            </button>
            <button class="btn-secondary" onclick="showSection('pomodoro')">
              <i class="fas fa-play"></i> Start Focus
            </button>
            <button class="btn-secondary" onclick="showSection('grades')">
              <i class="fas fa-plus"></i> Add Grade
            </button>
          </div>
        </div>

        <!-- TASKS SECTION -->
        <div id="section-tasks" class="section-content hidden">
          <div class="search-container">
            <div class="search-box">
              <i class="fas fa-search"></i>
              <input
                type="text"
                id="search-input"
                placeholder="Search tasks..."
              />
            </div>
          </div>

          <div class="controls-container">
            <button id="toggle-form-btn" class="btn-secondary">
              <i class="fas fa-plus"></i> New Task
            </button>

            <div class="filters">
              <select id="filter-category">
                <option value="all">ðŸ“ All Categories</option>
                <option value="Homework">ðŸ“ Homework</option>
                <option value="Project">ðŸ’¼ Project</option>
                <option value="Exam">ðŸ“– Exam</option>
                <option value="Reading">ðŸ“š Reading</option>
                <option value="Personal">ðŸ‘¤ Personal</option>
                <option value="Research">ðŸ” Research</option>
                <option value="Presentation">ðŸ“Š Presentation</option>
                <option value="Lab">ðŸ§ª Lab</option>
                <option value="Group">ðŸ‘¥ Group</option>
                <option value="Assignment">ðŸ“‹ Assignment</option>
                <option value="Tutorial">ðŸŽ¯ Tutorial</option>
                <option value="Practice">âœï¸ Practice</option>
                <option value="Review">ðŸ” Review</option>
              </select>
              <select id="sort-tasks">
                <option value="date-asc">ðŸ“… Due: Soonest</option>
                <option value="date-desc">ðŸ“… Due: Latest</option>
                <option value="priority">âš¡ Priority</option>
                <option value="created">ðŸ†• Recently Added</option>
              </select>
              <button id="export-btn" class="btn-icon" title="Export CSV">
                <i class="fas fa-file-csv"></i>
              </button>
            </div>
          </div>

          <form id="task-form" class="hidden">
            <div class="form-header">
              <h3><i class="fas fa-plus-circle"></i> Add New Task</h3>
              <button type="button" id="close-form-btn" class="btn-icon">
                <i class="fas fa-times"></i>
              </button>
            </div>
            <div class="form-row">
              <input
                type="text"
                id="task-title"
                placeholder="ðŸ“Œ Task Title"
                required
              />
              <input
                type="text"
                id="task-subject"
                placeholder="ðŸ“š Subject"
                required
              />
            </div>
            <div class="form-row">
              <select id="task-category">
                <option value="Homework">ðŸ“ Homework</option>
                <option value="Project">ðŸ’¼ Project</option>
                <option value="Exam">ðŸ“– Exam</option>
                <option value="Reading">ðŸ“š Reading</option>
                <option value="Personal">ðŸ‘¤ Personal</option>
                <option value="Research">ðŸ” Research</option>
                <option value="Presentation">ðŸ“Š Presentation</option>
                <option value="Lab">ðŸ§ª Lab</option>
                <option value="Group">ðŸ‘¥ Group</option>
                <option value="Assignment">ðŸ“‹ Assignment</option>
                <option value="Tutorial">ðŸŽ¯ Tutorial</option>
                <option value="Practice">âœï¸ Practice</option>
                <option value="Review">ðŸ” Review</option>
              </select>
              <select id="task-priority">
                <option value="Low">ðŸŸ¢ Low Priority</option>
                <option value="Medium" selected>ðŸŸ¡ Medium Priority</option>
                <option value="High">ðŸ”´ High Priority</option>
              </select>
            </div>
            <div class="form-row">
              <input type="datetime-local" id="task-due" required />
              <input
                type="number"
                id="task-estimated"
                placeholder="â±ï¸ Estimated mins"
                min="1"
              />
            </div>
            <div class="form-row">
              <input
                type="text"
                id="task-notes"
                placeholder="ðŸ“ Notes (Optional)"
              />
            </div>
            <button type="submit" class="btn-primary">
              <i class="fas fa-check"></i> Add Task
            </button>
          </form>

          <div class="list-tabs">
            <button class="list-tab active" data-view="pending">
              <i class="fas fa-clock"></i> To Do
            </button>
            <button class="list-tab" data-view="completed">
              <i class="fas fa-check-circle"></i> Completed
            </button>
            <button class="list-tab" data-view="all">
              <i class="fas fa-list"></i> All
            </button>
          </div>

          <div id="task-list" class="task-list">
            <div class="empty-state">
              <i class="fas fa-tasks"></i>
              <h3>No tasks yet</h3>
              <p>Add your first task to get started!</p>
            </div>
          </div>
        </div>

        <!-- POMODORO SECTION -->
        <div id="section-pomodoro" class="section-content hidden">
          <div class="dashboard-grid" style="grid-template-columns: 1fr 1fr">
            <div class="pomodoro-container">
              <div
                style="
                  display: flex;
                  justify-content: center;
                  align-items: center;
                  gap: 10px;
                  margin-bottom: 1.5rem;
                "
              >
                <h3 style="margin: 0">
                  <i class="fas fa-stopwatch"></i> Pomodoro Timer
                </h3>
                <button
                  id="pomodoro-pip-btn"
                  class="btn-icon"
                  title="Pop out timer"
                >
                  <i class="fas fa-external-link-alt"></i>
                </button>
              </div>

              <div class="timer-mode-tabs">
                <button class="mode-tab active" data-mode="work">Focus</button>
                <button class="mode-tab" data-mode="short">Short Break</button>
                <button class="mode-tab" data-mode="long">Long Break</button>
              </div>

              <div class="pomodoro-timer">
                <div class="timer-circle">
                  <div class="timer-progress" id="timer-progress"></div>
                  <div class="timer-display" id="timer-display">25:00</div>
                  <div class="timer-label" id="timer-label">Focus Time</div>
                </div>
              </div>

              <div class="pomodoro-controls">
                <button
                  class="pomodoro-btn reset"
                  id="pomo-reset"
                  title="Reset"
                >
                  <i class="fas fa-redo"></i>
                </button>
                <button
                  class="pomodoro-btn play"
                  id="pomo-start"
                  title="Start/Pause"
                >
                  <i class="fas fa-play" id="pomo-icon"></i>
                </button>
                <button class="pomodoro-btn reset" id="pomo-skip" title="Skip">
                  <i class="fas fa-forward"></i>
                </button>
              </div>

              <div class="pomodoro-stats">
                <div class="pomo-stat">
                  <span id="pomo-completed">0</span>
                  <small>Sessions Today</small>
                </div>
                <div class="pomo-stat">
                  <span id="pomo-total-time">0h</span>
                  <small>Focus Time</small>
                </div>
                <div class="pomo-stat">
                  <span id="pomo-streak">0</span>
                  <small>Best Streak</small>
                </div>
              </div>
            </div>

            <div class="study-tracker">
              <h3 style="margin-bottom: 1.5rem">
                <i class="fas fa-cog"></i> Timer Settings
              </h3>

              <div style="margin-bottom: 1.5rem">
                <label
                  style="
                    display: block;
                    margin-bottom: 0.5rem;
                    color: var(--text-light);
                  "
                  >Focus Duration (minutes)</label
                >
                <input
                  type="number"
                  id="focus-duration"
                  value="25"
                  min="1"
                  max="60"
                  style="
                    width: 100%;
                    padding: 12px;
                    border-radius: 12px;
                    border: 2px solid var(--border);
                    background: var(--bg);
                    color: var(--text);
                  "
                />
              </div>

              <div style="margin-bottom: 1.5rem">
                <label
                  style="
                    display: block;
                    margin-bottom: 0.5rem;
                    color: var(--text-light);
                  "
                  >Short Break (minutes)</label
                >
                <input
                  type="number"
                  id="short-break"
                  value="5"
                  min="1"
                  max="30"
                  style="
                    width: 100%;
                    padding: 12px;
                    border-radius: 12px;
                    border: 2px solid var(--border);
                    background: var(--bg);
                    color: var(--text);
                  "
                />
              </div>

              <div style="margin-bottom: 1.5rem">
                <label
                  style="
                    display: block;
                    margin-bottom: 0.5rem;
                    color: var(--text-light);
                  "
                  >Long Break (minutes)</label
                >
                <input
                  type="number"
                  id="long-break"
                  value="15"
                  min="1"
                  max="60"
                  style="
                    width: 100%;
                    padding: 12px;
                    border-radius: 12px;
                    border: 2px solid var(--border);
                    background: var(--bg);
                    color: var(--text);
                  "
                />
              </div>

              <div style="margin-bottom: 1.5rem">
                <label
                  style="
                    display: block;
                    margin-bottom: 0.5rem;
                    color: var(--text-light);
                  "
                  >Daily Study Goal (hours)</label
                >
                <input
                  type="number"
                  id="daily-goal"
                  value="2"
                  min="0.5"
                  max="12"
                  step="0.5"
                  style="
                    width: 100%;
                    padding: 12px;
                    border-radius: 12px;
                    border: 2px solid var(--border);
                    background: var(--bg);
                    color: var(--text);
                  "
                />
              </div>

              <button
                class="btn-primary"
                id="save-timer-settings"
                style="width: 100%"
              >
                <i class="fas fa-save"></i> Save Settings
              </button>

              <div
                style="
                  margin-top: 2rem;
                  padding-top: 1.5rem;
                  border-top: 1px solid var(--border);
                "
              >
                <h4 style="margin-bottom: 1rem">
                  <i class="fas fa-music"></i> Ambient Sounds
                </h4>
                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap">
                  <button class="btn-icon sound-btn" data-sound="rain">
                    ðŸŒ§ï¸ Rain
                  </button>
                  <button class="btn-icon sound-btn" data-sound="forest">
                    ðŸŒ² Forest
                  </button>
                  <button class="btn-icon sound-btn" data-sound="cafe">
                    â˜• CafÃ©
                  </button>
                  <button class="btn-icon sound-btn" data-sound="waves">
                    ðŸŒŠ Waves
                  </button>
                  <button class="btn-icon sound-btn" data-sound="none">
                    ðŸ”‡ None
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- GRADES SECTION -->
        <div id="section-grades" class="section-content hidden">
          <div class="grades-container">
            <div class="gpa-display">
              <div class="gpa-label">Current GPA</div>
              <div class="gpa-value" id="gpa-display">0.00</div>
              <div class="gpa-label">Scale: 4.0</div>
            </div>

            <h3 style="margin-bottom: 1rem">
              <i class="fas fa-plus-circle"></i> Add Grade
            </h3>
            <form class="grade-form" id="grade-form">
              <div>
                <label>Subject</label>
                <input
                  type="text"
                  id="grade-subject"
                  placeholder="e.g. Mathematics"
                  required
                />
              </div>
              <div>
                <label>Score</label>
                <input
                  type="number"
                  id="grade-score"
                  placeholder="0-100"
                  min="0"
                  max="100"
                  required
                />
              </div>
              <div>
                <label>Credits</label>
                <input
                  type="number"
                  id="grade-credits"
                  placeholder="3"
                  min="1"
                  max="6"
                  value="3"
                  required
                />
              </div>
              <div>
                <label>Type</label>
                <select id="grade-type">
                  <option value="Exam">Exam</option>
                  <option value="Quiz">Quiz</option>
                  <option value="Assignment">Assignment</option>
                  <option value="Project">Project</option>
                </select>
              </div>
              <div>
                <label>&nbsp;</label>
                <button type="submit" class="btn-primary" style="width: 100%">
                  <i class="fas fa-plus"></i>
                </button>
              </div>
            </form>

            <h3 style="margin: 2rem 0 1rem">
              <i class="fas fa-history"></i> Grade History
            </h3>
            <div class="grades-list" id="grades-list">
              <div class="empty-state">
                <i class="fas fa-chart-line"></i>
                <h3>No grades yet</h3>
                <p>Add your grades to calculate GPA</p>
              </div>
            </div>
          </div>
        </div>

        <!-- CALENDAR SECTION -->
        <div id="section-calendar" class="section-content hidden">
          <div class="calendar-container">
            <div class="calendar-header">
              <button id="prev-month">
                <i class="fas fa-chevron-left"></i>
              </button>
              <h3 id="calendar-month-year">Month Year</h3>
              <button id="next-month">
                <i class="fas fa-chevron-right"></i>
              </button>
            </div>
            <div class="calendar-days-header">
              <div>Sun</div>
              <div>Mon</div>
              <div>Tue</div>
              <div>Wed</div>
              <div>Thu</div>
              <div>Fri</div>
              <div>Sat</div>
            </div>
            <div id="calendar-grid" class="calendar-grid">
              <!-- Days will be generated by JS -->
            </div>
            <div id="calendar-task-list" class="calendar-task-preview">
              <p class="text-muted">Select a date to view tasks</p>
            </div>
          </div>
        </div>

        <!-- NOTES SECTION -->
        <div id="section-notes" class="section-content hidden">
          <div class="notes-container">
            <div
              style="
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 1.5rem;
              "
            >
              <h3><i class="fas fa-sticky-note"></i> Quick Notes</h3>
              <button class="btn-primary" id="add-note-btn">
                <i class="fas fa-plus"></i> Add Note
              </button>
            </div>

            <div
              style="
                margin-bottom: 1rem;
                display: flex;
                gap: 10px;
                align-items: center;
              "
            >
              <i class="fas fa-filter text-muted"></i>
              <select
                id="note-filter-tag"
                style="
                  padding: 8px;
                  border-radius: 8px;
                  border: 1px solid var(--border);
                  background: var(--bg);
                  color: var(--text);
                "
              >
                <option value="">All Tags</option>
              </select>
            </div>

            <div class="notes-grid" id="notes-grid">
              <div class="empty-state" style="grid-column: 1 / -1">
                <i class="fas fa-sticky-note"></i>
                <h3>No notes yet</h3>
                <p>Create your first quick note!</p>
              </div>
            </div>
          </div>
        </div>

        <!-- ACHIEVEMENTS SECTION -->
        <div id="section-achievements" class="section-content hidden">
          <div style="text-align: center; margin-bottom: 2rem">
            <h2>
              <i class="fas fa-trophy" style="color: gold"></i> Your
              Achievements
            </h2>
            <p style="color: var(--text-light)">
              Complete challenges to unlock badges!
            </p>
          </div>

          <div class="achievements-grid" id="achievements-grid">
            <!-- Achievements will be rendered here -->
          </div>
        </div>
      </main>
    </section>

    <!-- EDIT TASK MODAL -->
    <div id="edit-modal" class="modal-overlay hidden">
      <div class="modal">
        <h3><i class="fas fa-edit"></i> Edit Task</h3>
        <form id="edit-form">
          <input type="hidden" id="edit-id" />
          <div class="form-row">
            <input
              type="text"
              id="edit-title"
              placeholder="Task Title"
              required
            />
          </div>
          <div class="form-row">
            <input
              type="text"
              id="edit-subject"
              placeholder="Subject"
              required
            />
          </div>
          <div class="form-row">
            <select id="edit-category">
              <option value="Homework">Homework</option>
              <option value="Project">Project</option>
              <option value="Exam">Exam</option>
              <option value="Reading">Reading</option>
              <option value="Personal">Personal</option>
              <option value="Research">Research</option>
              <option value="Presentation">Presentation</option>
              <option value="Lab">Lab</option>
              <option value="Group">Group</option>
            </select>
            <select id="edit-priority">
              <option value="Low">Low</option>
              <option value="Medium">Medium</option>
              <option value="High">High</option>
            </select>
          </div>
          <div class="form-row">
            <input type="datetime-local" id="edit-due" required />
          </div>
          <div class="form-row">
            <input type="text" id="edit-notes" placeholder="Notes" />
          </div>
          <div class="modal-actions">
            <button type="button" id="cancel-edit" class="btn-secondary">
              Cancel
            </button>
            <button type="submit" class="btn-primary">Save Changes</button>
          </div>
        </form>
      </div>
    </div>

    <!-- ADD NOTE MODAL -->
    <div id="note-modal" class="modal-overlay hidden">
      <div class="modal">
        <h3><i class="fas fa-sticky-note"></i> New Note</h3>
        <form id="note-form">
          <div class="form-row">
            <input
              type="text"
              id="note-title"
              placeholder="Note Title"
              required
            />
          </div>
          <div class="form-row">
            <textarea
              id="note-content"
              placeholder="Write your note here..."
              rows="5"
              style="
                width: 100%;
                padding: 14px;
                border-radius: 12px;
                border: 2px solid var(--border);
                background: var(--bg);
                color: var(--text);
                resize: vertical;
              "
              required
            ></textarea>
          </div>
          <div class="form-row">
            <input
              type="text"
              id="note-tags"
              placeholder="Tags (comma separated)... e.g. #important, #ideas"
            />
          </div>
          <div class="form-row">
            <select id="note-color">
              <option value="1">ðŸ”´ Red</option>
              <option value="2">ðŸŸ¡ Yellow</option>
              <option value="3">ðŸŸ¢ Green</option>
              <option value="4">ðŸ”µ Blue</option>
              <option value="5">ðŸŸ£ Purple</option>
            </select>
          </div>
          <div class="modal-actions">
            <button type="button" id="cancel-note" class="btn-secondary">
              Cancel
            </button>
            <button type="submit" class="btn-primary">Save Note</button>
          </div>
        </form>
      </div>
    </div>

    <!-- FOCUS MODE OVERLAY -->
    <div id="focus-mode" class="focus-mode-overlay hidden">
      <div class="focus-mode-content">
        <h2><i class="fas fa-bullseye"></i> Focus Mode Active</h2>
        <div class="focus-mode-timer" id="focus-timer-display">25:00</div>
        <div class="focus-task-display" id="focus-task">
          Stay focused on your current task
        </div>
        <div style="display: flex; gap: 1rem; justify-content: center">
          <button class="btn-primary" id="focus-pause">
            <i class="fas fa-pause"></i> Pause
          </button>
          <button class="btn-secondary" id="exit-focus">
            <i class="fas fa-times"></i> Exit Focus Mode
          </button>
        </div>
        <div class="focus-quote" id="focus-quote">
          "The secret of getting ahead is getting started." - Mark Twain
        </div>
      </div>
    </div>

    <!-- FIREBASE SDK -->

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <script>
      // =============================================
      // ðŸ”¥ FIREBASE CONFIGURATION
      // =============================================
      const firebaseConfig = {
  apiKey: "AIzaSyBPpm5ttvLnQ9CcbvlSmd0DrKyxtmlEJJA",
  authDomain: "student-task-app-4d0ef.firebaseapp.com",
  databaseURL: "https://student-task-app-4d0ef-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "student-task-app-4d0ef",
  storageBucket: "student-task-app-4d0ef.firebasestorage.app",
  messagingSenderId: "458507771913",
  appId: "1:458507771913:web:699328c6aff9a61bba58d8"
};

      firebase.initializeApp(firebaseConfig);
      const auth = firebase.auth();
      const db = firebase.database();

      // =============================================
      // ðŸ“¦ STATE
      // =============================================
      let currentUser = null;
      let tasks = [];
      let grades = [];
      let notes = [];
      let currentFilter = "all";
      let currentSort = "date-asc";
      let currentView = "pending";
      let searchQuery = "";

      // Pomodoro State
      let pomodoroTimer = null;
      let pomodoroSeconds = 25 * 60;
      let pomodoroMode = "work";
      let pomodoroRunning = false;
      let pomodoroSettings = {
        focus: 25,
        shortBreak: 5,
        longBreak: 15,
        dailyGoal: 2,
      };
      let todayPomodoros = 0;
      let totalFocusMinutes = 0;

      // Study tracking
      let studyData = {
        today: 0,
        weekly: [0, 0, 0, 0, 0, 0, 0],
        streak: 0,
        lastStudyDate: null,
      };

      // Achievements
      const achievementsList = [
        {
          id: "first_task",
          icon: "ðŸŽ¯",
          title: "First Step",
          desc: "Add your first task",
          condition: (d) => d.tasks >= 1,
        },
        {
          id: "task_master",
          icon: "ðŸ“‹",
          title: "Task Master",
          desc: "Complete 10 tasks",
          condition: (d) => d.completed >= 10,
        },
        {
          id: "task_legend",
          icon: "ðŸ†",
          title: "Task Legend",
          desc: "Complete 50 tasks",
          condition: (d) => d.completed >= 50,
        },
        {
          id: "pomo_starter",
          icon: "ðŸ…",
          title: "Pomodoro Starter",
          desc: "Complete 1 pomodoro",
          condition: (d) => d.pomodoros >= 1,
        },
        {
          id: "pomo_pro",
          icon: "â°",
          title: "Focus Pro",
          desc: "Complete 25 pomodoros",
          condition: (d) => d.pomodoros >= 25,
        },
        {
          id: "streak_3",
          icon: "ðŸ”¥",
          title: "On Fire",
          desc: "3 day study streak",
          condition: (d) => d.streak >= 3,
        },
        {
          id: "streak_7",
          icon: "ðŸ’ª",
          title: "Week Warrior",
          desc: "7 day study streak",
          condition: (d) => d.streak >= 7,
        },
        {
          id: "streak_30",
          icon: "ðŸŒŸ",
          title: "Monthly Master",
          desc: "30 day study streak",
          condition: (d) => d.streak >= 30,
        },
        {
          id: "grade_a",
          icon: "ðŸ“š",
          title: "Honor Student",
          desc: "Get an A grade",
          condition: (d) => d.hasAGrade,
        },
        {
          id: "gpa_3",
          icon: "ðŸŽ“",
          title: "Dean's List",
          desc: "Achieve 3.0+ GPA",
          condition: (d) => d.gpa >= 3.0,
        },
        {
          id: "gpa_4",
          icon: "ðŸ‘‘",
          title: "Perfect Scholar",
          desc: "Achieve 4.0 GPA",
          condition: (d) => d.gpa >= 4.0,
        },
        {
          id: "early_bird",
          icon: "ðŸŒ…",
          title: "Early Bird",
          desc: "Study before 7 AM",
          condition: (d) => d.earlyBird,
        },
        {
          id: "night_owl",
          icon: "ðŸ¦‰",
          title: "Night Owl",
          desc: "Study after 11 PM",
          condition: (d) => d.nightOwl,
        },
        {
          id: "note_taker",
          icon: "ðŸ“",
          title: "Note Taker",
          desc: "Create 10 notes",
          condition: (d) => d.notes >= 10,
        },
        {
          id: "study_2h",
          icon: "ðŸ“–",
          title: "Dedicated",
          desc: "Study 2 hours in a day",
          condition: (d) => d.maxDailyStudy >= 120,
        },
        {
          id: "study_5h",
          icon: "ðŸ§ ",
          title: "Brain Power",
          desc: "Study 5 hours in a day",
          condition: (d) => d.maxDailyStudy >= 300,
        },
        {
          id: "consistency_king",
          icon: "ðŸ’Ž",
          title: "Consistency King",
          desc: "Maintain a 100-day streak",
          condition: (d) => d.streak >= 100,
        },
        {
          id: "marathon_study",
          icon: "ðŸƒ",
          title: "Study Marathon",
          desc: "Study for 10 hours in a single day",
          condition: (d) => d.maxDailyStudy >= 600,
        },
        {
          id: "deep_work",
          icon: "ðŸŒŠ",
          title: "Deep Work Master",
          desc: "Complete 100 pomodoros",
          condition: (d) => d.pomodoros >= 100,
        },
        {
          id: "weekend_warrior",
          icon: "ðŸ¤º",
          title: "Weekend Warrior",
          desc: "Complete 5 tasks on a Sunday",
          condition: (d) => d.sundayTasks >= 5,
        },
        {
          id: "librarian",
          icon: "ðŸ“š",
          title: "The Librarian",
          desc: "Create 50 detailed notes",
          condition: (d) => d.notes >= 50,
        },
        {
          id: "quick_learner",
          icon: "âš¡",
          title: "Quick Learner",
          desc: "Complete a task in under 15 minutes",
          condition: (d) => d.fastTaskCompleted,
        },
        {
          id: "all_rounder",
          icon: "ðŸŽ¯",
          title: "All Rounder",
          desc: "Complete tasks in 5 different subjects",
          condition: (d) => d.categoriesUsed >= 5,
        },
        {
          id: "zen_mode",
          icon: "ðŸ§˜",
          title: "Zen Mode",
          desc: "Complete 4 pomodoros without any interruptions",
          condition: (d) => d.uninterruptedPomos >= 4,
        },
        {
          id: "social_scholar",
          icon: "ðŸ¤",
          title: "Social Scholar",
          desc: "Join 5 group study sessions",
          condition: (d) => d.groupSessions >= 5,
        },
        {
          id: "persistence",
          icon: "ðŸ§—",
          title: "Pure Persistence",
          desc: "Complete a task that was pending for over a week",
          condition: (d) => d.oldTaskCompleted,
        },
        {
          id: "monk_mode",
          icon: "â›©ï¸",
          title: "Monk Mode",
          desc: "Complete 12 hours of study in one day",
          condition: (d) => d.maxDailyStudy >= 720,
        },
        {
          id: "century_club",
          icon: "ðŸ’¯",
          title: "The Century Club",
          desc: "Complete 100 tasks in a single month",
          condition: (d) => d.monthlyTasks >= 100,
        },
        {
          id: "unstoppable",
          icon: "ðŸš‚",
          title: "Unstoppable Force",
          desc: "Maintain a 365-day study streak",
          condition: (d) => d.streak >= 365,
        },
        {
          id: "no_sleep_squad",
          icon: "ðŸŒ‘",
          title: "Dead of Night",
          desc: "Complete 5 tasks between 12 AM and 4 AM",
          condition: (d) => d.lateNightGrind >= 5,
        },
        {
          id: "pomo_beast",
          icon: "ðŸ‘º",
          title: "Pomodoro Beast",
          desc: "Complete 500 total pomodoros",
          condition: (d) => d.pomodoros >= 500,
        },
        {
          id: "perfect_week",
          icon: "ðŸ›¡ï¸",
          title: "Flawless Victory",
          desc: "Complete all planned tasks for 7 days straight",
          condition: (d) => d.flawlessWeeks >= 1,
        },
        {
          id: "knowledge_titan",
          icon: "ðŸ›ï¸",
          title: "Knowledge Titan",
          desc: "Create 200 study notes",
          condition: (d) => d.notes >= 200,
        },
        {
          id: "speed_demon",
          icon: "ðŸŽï¸",
          title: "Speed Demon",
          desc: "Complete 10 tasks in under 2 hours",
          condition: (d) => d.rapidTasks,
        },
        {
          id: "obsessed",
          icon: "ðŸŒ€",
          title: "Obsessed",
          desc: "Spend 50 hours studying in a single week",
          condition: (d) => d.weeklyStudyHours >= 50,
        },
        {
          id: "the_architect",
          icon: "ðŸ“",
          title: "The Architect",
          desc: "Complete 1000 total tasks",
          condition: (d) => d.completed >= 1000,
        },
        {
          id: "monk_mode_extreme",
          icon: "â›©ï¸",
          title: "Monk Mode",
          desc: "Study 12 hours in a day",
          condition: (d) => d.maxDailyStudy >= 720,
        },
        {
          id: "flawless_victory",
          icon: "ðŸ›¡ï¸",
          title: "Flawless Victory",
          desc: "7 days of 100% task completion",
          condition: (d) => d.flawlessWeeks >= 1,
        },
        {
          id: "unstoppable_legend",
          icon: "ðŸš‚",
          title: "Unstoppable",
          desc: "365-day study streak",
          condition: (d) => d.streak >= 365,
        },
        {
          id: "dead_of_night",
          icon: "ðŸŒ‘",
          title: "Dead of Night",
          desc: "Complete 5 tasks between 12 AM and 4 AM",
          condition: (d) => d.lateNightGrind >= 5,
          difficulty: "Hard",
        },
        {
          id: "pomo_beast",
          icon: "ðŸ‘º",
          title: "Pomodoro Beast",
          desc: "Complete 500 total pomodoros",
          condition: (d) => d.pomodoros >= 500,
          difficulty: "Extreme",
        },
        {
          id: "century_club",
          icon: "ðŸ’¯",
          title: "The Century Club",
          desc: "Complete 100 tasks in a single month",
          condition: (d) => d.monthlyTasks >= 100,
          difficulty: "Hard",
        },
        {
          id: "speed_demon_new",
          icon: "âš¡",
          title: "Speed Demon",
          desc: "Complete 10 tasks in under 2 hours",
          condition: (d) => d.rapidTasks,
          difficulty: "Hard",
        },
        {
          id: "all_rounder",
          icon: "ðŸŽ¯",
          title: "All Rounder",
          desc: "Complete tasks in 5 different subjects",
          condition: (d) => d.categoriesUsed >= 5,
          difficulty: "Medium",
        },
        {
          id: "zen_mode",
          icon: "ðŸ§˜",
          title: "Zen Mode",
          desc: "Complete 4 pomodoros without any interruptions",
          condition: (d) => d.uninterruptedPomos >= 4,
          difficulty: "Hard",
        },
        {
          id: "social_scholar",
          icon: "ðŸ¤",
          title: "Social Scholar",
          desc: "Join 5 group study sessions",
          condition: (d) => d.groupSessions >= 5,
          difficulty: "Medium",
        },
        {
          id: "pure_persistence",
          icon: "ðŸ§—",
          title: "Pure Persistence",
          desc: "Complete a task that was pending for over a week",
          condition: (d) => d.oldTaskCompleted,
          difficulty: "Hard",
        },
      ];

      let unlockedAchievements = [];

      // Motivational quotes
      const quotes = [
        "The secret of getting ahead is getting started. - Mark Twain",
        "It always seems impossible until it's done. - Nelson Mandela",
        "Success is not final, failure is not fatal. - Winston Churchill",
        "The only way to do great work is to love what you do. - Steve Jobs",
        "Education is the most powerful weapon. - Nelson Mandela",
        "The future belongs to those who believe in their dreams. - Eleanor Roosevelt",
        "Don't watch the clock; do what it does. Keep going. - Sam Levenson",
        "Learning is not attained by chance, it must be sought. - Abigail Adams",
      ];

      // =============================================
      // ðŸ” AUTHENTICATION
      // =============================================
      auth.onAuthStateChanged((user) => {
        console.log(
          "Auth state changed:",
          user ? "Logged in" : "Logged out",
          user,
        );
        if (user) {
          currentUser = user;
          console.log("User logged in:", user.uid, user.email);
          document.getElementById("auth-section").classList.add("hidden");
          document.getElementById("app-section").classList.remove("hidden");

          db.ref(`users/${user.uid}/name`)
            .once("value")
            .then((snapshot) => {
              const name = snapshot.val() || user.email.split("@")[0];
              document.getElementById("user-name").textContent = name;
              console.log("User name set:", name);
            });

          console.log("Loading all data...");
          loadAllData();
          showToast("Welcome back! ðŸ‘‹", "success");
        } else {
          console.log("User logged out");
          currentUser = null;
          document.getElementById("auth-section").classList.remove("hidden");
          document.getElementById("app-section").classList.add("hidden");
        }
      });

      // Login
      document
        .getElementById("login-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const email = document.getElementById("login-email").value;
          const pass = document.getElementById("login-password").value;
          try {
            await auth.signInWithEmailAndPassword(email, pass);
          } catch (err) {
            showToast(getErrorMessage(err.code), "error");
          }
        });

      // Register
      document
        .getElementById("register-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const name = document.getElementById("reg-name").value;
          const email = document.getElementById("reg-email").value;
          const pass = document.getElementById("reg-password").value;
          try {
            const cred = await auth.createUserWithEmailAndPassword(email, pass);
            await db.ref(`users/${cred.user.uid}`).set({
              name,
              email,
              createdAt: Date.now(),
            });
            showToast(`Welcome ${name}! ðŸŽ‰`, "success");
          } catch (err) {
            showToast(getErrorMessage(err.code), "error");
          }
        });

      document.getElementById("logout-btn").addEventListener("click", () => {
        auth.signOut();
        showToast("Logged out!", "success");
      });

      document
        .getElementById("tab-login")
        .addEventListener("click", () => toggleAuthTabs(true));
      document
        .getElementById("tab-register")
        .addEventListener("click", () => toggleAuthTabs(false));

      function toggleAuthTabs(isLogin) {
        document
          .getElementById("tab-login")
          .classList.toggle("active", isLogin);
        document
          .getElementById("tab-register")
          .classList.toggle("active", !isLogin);
        document
          .getElementById("login-form")
          .classList.toggle("hidden", !isLogin);
        document
          .getElementById("register-form")
          .classList.toggle("hidden", isLogin);
      }

      function getErrorMessage(code) {
        const messages = {
          "auth/email-already-in-use": "Email already registered!",
          "auth/invalid-email": "Invalid email!",
          "auth/weak-password": "Password too weak!",
          "auth/user-not-found": "User not found!",
          "auth/wrong-password": "Wrong password!",
        };
        return messages[code] || "An error occurred";
      }

      // =============================================
      // ðŸ“Š DATA LOADING
      // =============================================
      function loadAllData() {
        console.log("loadAllData called for user:", currentUser.uid);

        // Load Tasks
        console.log("Loading tasks...");
        db.ref(`tasks/${currentUser.uid}`).on("value", (snapshot) => {
          console.log("Tasks data received:", snapshot.val());
          tasks = [];
          snapshot.forEach((child) =>
            tasks.push({ id: child.key, ...child.val() }),
          );
          console.log("Tasks loaded:", tasks.length);
          renderTasks();
          updateStats();
        });

        // Load Grades
        db.ref(`grades/${currentUser.uid}`).on("value", (snapshot) => {
          grades = [];
          snapshot.forEach((child) =>
            grades.push({ id: child.key, ...child.val() }),
          );
          renderGrades();
          calculateGPA();
        });

        // Load Notes
        db.ref(`notes/${currentUser.uid}`).on("value", (snapshot) => {
          notes = [];
          snapshot.forEach((child) =>
            notes.push({ id: child.key, ...child.val() }),
          );
          renderNotes();
        });

        // Load Study Data
        console.log("Loading study data...");
        db.ref(`studyData/${currentUser.uid}`).on("value", (snapshot) => {
          console.log("Study data received:", snapshot.val());
          if (snapshot.exists()) {
            studyData = { ...studyData, ...snapshot.val() };
            console.log("Study data updated:", studyData);
            checkAndResetDaily();
            updateStudyDisplay();
            updateStreak();
          } else {
            console.log("No study data found, initializing...");
            studyData = {
              today: 0,
              weekly: [0, 0, 0, 0, 0, 0, 0],
              streak: 0,
              lastStudyDate: null,
            };
            updateStudyDisplay();
            updateStreak();
          }
        });

        // Load Pomodoro Stats
        db.ref(`pomodoroStats/${currentUser.uid}`).on("value", (snapshot) => {
          if (snapshot.exists()) {
            const data = snapshot.val();
            todayPomodoros = data.todayCount || 0;
            totalFocusMinutes = data.totalMinutes || 0;
            document.getElementById("pomo-completed").textContent =
              todayPomodoros;
            document.getElementById("pomo-today").textContent = todayPomodoros;
            document.getElementById("pomo-total-time").textContent =
              Math.floor(totalFocusMinutes / 60) + "h";
          }
        });

        // Load Achievements
        console.log("Loading achievements...");
        db.ref(`achievements/${currentUser.uid}`).on("value", (snapshot) => {
          console.log("Achievements data received:", snapshot.val());
          unlockedAchievements = snapshot.val() || [];
          console.log("Loaded achievements:", unlockedAchievements);
          renderAchievements();
        });

        // Load Settings
        db.ref(`settings/${currentUser.uid}`)
          .once("value")
          .then((snapshot) => {
            if (snapshot.exists()) {
              pomodoroSettings = { ...pomodoroSettings, ...snapshot.val() };
              document.getElementById("focus-duration").value =
                pomodoroSettings.focus;
              document.getElementById("short-break").value =
                pomodoroSettings.shortBreak;
              document.getElementById("long-break").value =
                pomodoroSettings.longBreak;
              document.getElementById("daily-goal").value =
                pomodoroSettings.dailyGoal;
              document.getElementById("daily-goal-display").textContent =
                pomodoroSettings.dailyGoal + "h";
              pomodoroSeconds = pomodoroSettings.focus * 60;
              updateTimerDisplay();
            }
          });
      }

      // =============================================
      // ðŸ“‹ TASKS
      // =============================================
      document
        .getElementById("task-form")
        .addEventListener("submit", async (e) => {
          console.log("Task form submitted");
          e.preventDefault();

          // Validate that user is logged in
          if (!currentUser) {
            showToast("Please log in first", "error");
            return;
          }

          // Validate category
          const allowedCategories = [
            "Homework",
            "Project",
            "Exam",
            "Reading",
            "Personal",
            "Research",
            "Presentation",
            "Lab",
            "Group",
            "Assignment",
            "Tutorial",
            "Practice",
            "Review",
          ];
          const category = document.getElementById("task-category").value;
          console.log("Selected category:", category);
          if (!allowedCategories.includes(category)) {
            showToast("Invalid category selected", "error");
            return;
          }

          // Validate subject length
          const subject = document.getElementById("task-subject").value;
          console.log("Subject:", subject);
          if (subject.length < 2) {
            showToast("Subject must be at least 2 characters", "error");
            return;
          }

          // Validate title length
          const title = document.getElementById("task-title").value;
          console.log("Title:", title);
          if (title.length < 3) {
            showToast("Title must be at least 3 characters", "error");
            return;
          }

          // Validate estimated time
          const estimated = document.getElementById("task-estimated").value;
          console.log("Estimated time:", estimated);
          if (estimated && (estimated < 1 || estimated > 1440)) {
            showToast("Estimated time must be between 1-1440 minutes", "error");
            return;
          }

          // Validate due date
          const dueDate = document.getElementById("task-due").value;
          if (!dueDate) {
            showToast("Please select a due date", "error");
            return;
          }

          const task = {
            title: document.getElementById("task-title").value,
            subject: document.getElementById("task-subject").value,
            category: document.getElementById("task-category").value,
            priority: document.getElementById("task-priority").value,
            dueDate: document.getElementById("task-due").value,
            estimated:
              parseInt(document.getElementById("task-estimated").value) || 30,
            notes: document.getElementById("task-notes").value,
            completed: false,
            createdAt: Date.now(),
          };

          console.log("Task object created:", task);
          console.log("Current user:", currentUser.uid);

          try {
            console.log("Attempting to save task to Firebase...");

            // First check if we can write to the database
            const testRef = db.ref(`.info/connected`);
            console.log("Firebase connection test:", testRef);

            const result = await db.ref(`tasks/${currentUser.uid}`).push(task);
            console.log("Task saved successfully:", result.key);

            // Add to local tasks array immediately for better UX
            tasks.push({ id: result.key, ...task });
            renderTasks();
            updateStats();

            document.getElementById("task-form").reset();
            document.getElementById("task-form").classList.add("hidden");
            showToast("Task added! âœ…", "success");
            checkAchievements();
          } catch (err) {
            console.error("Error adding task:", err);
            console.error("Error details:", err.message, err.code, err.stack);
            showToast(
              `Error adding task: ${err.message || "Unknown error"}`,
              "error",
            );
          }
        });

      window.toggleComplete = async (id, status) => {
        try {
          await db.ref(`tasks/${currentUser.uid}/${id}`).update({
            completed: !status,
            completedAt: !status ? Date.now() : null,
          });
          if (!status) {
            showToast("Task completed! ðŸŽ‰", "success");
            checkAchievements();
          }
        } catch (err) {
          console.error("Error updating task completion:", err);
          showToast(
            `Error updating task: ${err.message || "Unknown error"}`,
            "error",
          );
        }
      };

      window.deleteTask = async (id) => {
        if (confirm("Delete this task?")) {
          try {
            await db.ref(`tasks/${currentUser.uid}/${id}`).remove();
            showToast("Task deleted", "success");
          } catch (err) {
            console.error("Error deleting task:", err);
            showToast(
              `Error deleting task: ${err.message || "Unknown error"}`,
              "error",
            );
          }
        }
      };

      window.editTask = (id) => {
        const task = tasks.find((t) => t.id === id);
        if (!task) return;
        document.getElementById("edit-id").value = id;
        document.getElementById("edit-title").value = task.title;
        document.getElementById("edit-subject").value = task.subject;
        document.getElementById("edit-category").value = task.category;
        document.getElementById("edit-priority").value = task.priority;
        document.getElementById("edit-due").value = task.dueDate;
        document.getElementById("edit-notes").value = task.notes || "";
        document.getElementById("edit-modal").classList.remove("hidden");
      };

      document
        .getElementById("edit-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          // Validate category
          const allowedCategories = [
            "Homework",
            "Project",
            "Exam",
            "Reading",
            "Personal",
            "Research",
            "Presentation",
            "Lab",
            "Group",
            "Assignment",
            "Tutorial",
            "Practice",
            "Review",
          ];
          const category = document.getElementById("edit-category").value;
          if (!allowedCategories.includes(category)) {
            showToast("Invalid category selected", "error");
            return;
          }

          // Validate subject length
          const subject = document.getElementById("edit-subject").value;
          if (subject.length < 2) {
            showToast("Subject must be at least 2 characters", "error");
            return;
          }

          // Validate title length
          const title = document.getElementById("edit-title").value;
          if (title.length < 3) {
            showToast("Title must be at least 3 characters", "error");
            return;
          }

          const id = document.getElementById("edit-id").value;
          try {
            await db.ref(`tasks/${currentUser.uid}/${id}`).update({
              title: document.getElementById("edit-title").value,
              subject: document.getElementById("edit-subject").value,
              category: document.getElementById("edit-category").value,
              priority: document.getElementById("edit-priority").value,
              dueDate: document.getElementById("edit-due").value,
              notes: document.getElementById("edit-notes").value,
              updatedAt: Date.now(),
            });
            document.getElementById("edit-modal").classList.add("hidden");
            showToast("Task updated! âœ…", "success");
          } catch (err) {
            console.error("Error updating task:", err);
            showToast(
              `Error updating task: ${err.message || "Unknown error"}`,
              "error",
            );
          }
        });

      document.getElementById("cancel-edit").addEventListener("click", () => {
        document.getElementById("edit-modal").classList.add("hidden");
      });

      function renderTasks() {
        const list = document.getElementById("task-list");
        let filtered = tasks.filter((t) => {
          const matchCat =
            currentFilter === "all" || t.category === currentFilter;
          const matchSearch =
            !searchQuery ||
            t.title.toLowerCase().includes(searchQuery.toLowerCase()) ||
            t.subject.toLowerCase().includes(searchQuery.toLowerCase());
          let matchView = true;
          if (currentView === "completed") matchView = t.completed;
          else if (currentView === "pending") matchView = !t.completed;
          return matchCat && matchView && matchSearch;
        });

        filtered.sort((a, b) => {
          if (currentSort === "priority") {
            const map = { High: 3, Medium: 2, Low: 1 };
            return map[b.priority] - map[a.priority];
          } else if (currentSort === "date-asc") {
            return new Date(a.dueDate) - new Date(b.dueDate);
          } else if (currentSort === "date-desc") {
            return new Date(b.dueDate) - new Date(a.dueDate);
          }
          return b.createdAt - a.createdAt;
        });

        if (filtered.length === 0) {
          list.innerHTML = `<div class="empty-state"><i class="fas fa-tasks"></i><h3>No tasks</h3><p>Time to relax! ðŸŽ‰</p></div>`;
          return;
        }

        const now = new Date();
        const icons = {
          Homework: "ðŸ“",
          Project: "ðŸ’¼",
          Exam: "ðŸ“–",
          Reading: "ðŸ“š",
          Personal: "ðŸ‘¤",
        };

        list.innerHTML = filtered
          .map((task) => {
            const due = new Date(task.dueDate);
            const isOverdue = due < now && !task.completed;
            const timeLeft = Math.ceil((due - now) / (1000 * 60 * 60 * 24));
            let badge = "";
            if (isOverdue)
              badge = `<span class="badge badge-danger">âš ï¸ Overdue</span>`;
            else if (timeLeft <= 1 && !task.completed)
              badge = `<span class="badge badge-warning">ðŸ”¥ Due Soon</span>`;

            return `
                    <div class="task-card priority-${task.priority} ${isOverdue ? "overdue" : ""} ${task.completed ? "completed" : ""}">
                        <div class="task-info">
                            <h4>${icons[task.category] || "ðŸ“Œ"} ${task.title} <small style="font-weight:400; color:var(--text-light)">(${task.subject})</small></h4>
                            <div class="task-meta">
                                <span class="badge">${task.category}</span>
                                <span><i class="far fa-clock"></i> ${due.toLocaleDateString()} ${due.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" })}</span>
                                ${badge}
                            </div>
                            ${task.notes ? `<small style="display:block; margin-top:8px; color:var(--text-light)">ðŸ“ ${task.notes}</small>` : ""}
                        </div>
                        <div class="task-actions">
                            <button class="check-btn" onclick="toggleComplete('${task.id}', ${task.completed})" title="${task.completed ? "Reopen" : "Complete"}">
                                <i class="fas ${task.completed ? "fa-undo" : "fa-check"}"></i>
                            </button>
                            <button class="edit-btn" onclick="editTask('${task.id}')" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="delete-btn" onclick="deleteTask('${task.id}')" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
          })
          .join("");
      }

      function updateStats() {
        const total = tasks.length;
        const completed = tasks.filter((t) => t.completed).length;
        const pending = total - completed;
        const perc = total === 0 ? 0 : Math.round((completed / total) * 100);

        const now = new Date();
        const tomorrow = new Date(now.getTime() + 24 * 60 * 60 * 1000);
        const dueSoon = tasks.filter(
          (t) => !t.completed && new Date(t.dueDate) < tomorrow,
        ).length;

        document.getElementById("progress-fill").style.width = `${perc}%`;
        document.getElementById("progress-text").textContent = `${perc}%`;
        document.getElementById("total-count").textContent = total;
        document.getElementById("pending-count").textContent = pending;
        document.getElementById("due-soon-count").textContent = dueSoon;
      }

      // =============================================
      // ðŸ“Š GRADES
      // =============================================
      document
        .getElementById("grade-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const grade = {
            subject: document.getElementById("grade-subject").value,
            score: parseFloat(document.getElementById("grade-score").value),
            credits: parseInt(document.getElementById("grade-credits").value),
            type: document.getElementById("grade-type").value,
            createdAt: Date.now(),
          };
          try {
            await db.ref(`grades/${currentUser.uid}`).push(grade);
            document.getElementById("grade-form").reset();
            document.getElementById("grade-credits").value = 3;
            showToast("Grade added! ðŸ“Š", "success");
            checkAchievements();
          } catch (err) {
            console.error("Error adding grade:", err);
            showToast(
              `Error adding grade: ${err.message || "Unknown error"}`,
              "error",
            );
          }
        });

      window.deleteGrade = async (id) => {
        if (confirm("Delete this grade?")) {
          try {
            await db.ref(`grades/${currentUser.uid}/${id}`).remove();
            showToast("Grade deleted", "success");
          } catch (err) {
            console.error("Error deleting grade:", err);
            showToast(
              `Error deleting grade: ${err.message || "Unknown error"}`,
              "error",
            );
          }
        }
      };

      function renderGrades() {
        const list = document.getElementById("grades-list");
        if (grades.length === 0) {
          list.innerHTML = `<div class="empty-state"><i class="fas fa-chart-line"></i><h3>No grades</h3><p>Add grades to track GPA</p></div>`;
          return;
        }

        list.innerHTML = grades
          .sort((a, b) => b.createdAt - a.createdAt)
          .map((g) => {
            const letter = getLetterGrade(g.score);
            return `
                    <div class="grade-item">
                        <div class="grade-info">
                            <h4>${g.subject}</h4>
                            <span>${g.type} â€¢ ${g.credits} credits</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <div class="grade-score grade-${letter}">${g.score}%</div>
                            <button onclick="deleteGrade('${g.id}')" style="background: none; border: none; cursor: pointer; color: var(--danger); font-size: 1.1rem;">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
          })
          .join("");
      }

      function getLetterGrade(score) {
        if (score >= 90) return "A";
        if (score >= 80) return "B";
        if (score >= 70) return "C";
        if (score >= 60) return "D";
        return "F";
      }

      function getGradePoints(score) {
        if (score >= 93) return 4.0;
        if (score >= 90) return 3.7;
        if (score >= 87) return 3.3;
        if (score >= 83) return 3.0;
        if (score >= 80) return 2.7;
        if (score >= 77) return 2.3;
        if (score >= 73) return 2.0;
        if (score >= 70) return 1.7;
        if (score >= 67) return 1.3;
        if (score >= 63) return 1.0;
        if (score >= 60) return 0.7;
        return 0.0;
      }

      function calculateGPA() {
        if (grades.length === 0) {
          document.getElementById("gpa-display").textContent = "0.00";
          document.getElementById("current-gpa").textContent = "0.00";
          document.getElementById("grade-count").textContent = "0";
          return;
        }

        let totalPoints = 0;
        let totalCredits = 0;

        grades.forEach((g) => {
          const points = getGradePoints(g.score);
          totalPoints += points * g.credits;
          totalCredits += g.credits;
        });

        const gpa = (totalPoints / totalCredits).toFixed(2);
        document.getElementById("gpa-display").textContent = gpa;
        document.getElementById("current-gpa").textContent = gpa;
        document.getElementById("grade-count").textContent = grades.length;
      }

      // =============================================
      // ðŸ“ NOTES
      // =============================================
      document.getElementById("add-note-btn").addEventListener("click", () => {
        document.getElementById("note-modal").classList.remove("hidden");
      });

      document.getElementById("cancel-note").addEventListener("click", () => {
        document.getElementById("note-modal").classList.add("hidden");
      });

      document
        .getElementById("note-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          if (!currentUser) {
            showToast("Please log in first", "error");
            return;
          }

          const tagsInput = document.getElementById("note-tags").value;
          const tags = tagsInput
            .split(",")
            .map((t) => t.trim())
            .filter((t) => t.length > 0);

          const note = {
            title: document.getElementById("note-title").value,
            content: document.getElementById("note-content").value,
            color: document.getElementById("note-color").value,
            tags: tags,
            createdAt: Date.now(),
          };
          try {
            await db.ref(`notes/${currentUser.uid}`).push(note);
            document.getElementById("note-form").reset();
            document.getElementById("note-tags").value = ""; // Clear tags manually just in case
            document.getElementById("note-modal").classList.add("hidden");
            showToast("Note saved! ðŸ“", "success");
            checkAchievements();
          } catch (err) {
            console.error("Error saving note:", err);
            showToast(
              `Error saving note: ${err.message || "Unknown error"}`,
              "error",
            );
          }
        });

      window.deleteNote = async (id) => {
        if (confirm("Delete this note?")) {
          try {
            await db.ref(`notes/${currentUser.uid}/${id}`).remove();
            showToast("Note deleted", "success");
          } catch (err) {
            console.error("Error deleting note:", err);
            showToast(
              `Error deleting note: ${err.message || "Unknown error"}`,
              "error",
            );
          }
        }
      };

      let currentNoteFilterTag = "";

      document
        .getElementById("note-filter-tag")
        .addEventListener("change", (e) => {
          currentNoteFilterTag = e.target.value;
          renderNotes();
        });

      function renderNotes() {
        const grid = document.getElementById("notes-grid");
        const filterSelect = document.getElementById("note-filter-tag");

        // Extract all unique tags for filter
        const allTags = new Set();
        notes.forEach((n) => {
          if (n.tags && Array.isArray(n.tags)) {
            n.tags.forEach((t) => allTags.add(t));
          }
        });

        // Update filter options only if not currently focused (to avoid UX glitches)
        if (document.activeElement !== filterSelect) {
          const currentVal = filterSelect.value;
          filterSelect.innerHTML =
            '<option value="">All Tags</option>' +
            Array.from(allTags)
              .sort()
              .map((tag) => `<option value="${tag}">${tag}</option>`)
              .join("");
          filterSelect.value = currentVal;
        }

        // Filter notes
        let filteredNotes = notes;
        if (currentNoteFilterTag) {
          filteredNotes = notes.filter(
            (n) => n.tags && n.tags.includes(currentNoteFilterTag),
          );
        }

        if (filteredNotes.length === 0) {
          grid.innerHTML = `<div class="empty-state" style="grid-column: 1 / -1;"><i class="fas fa-sticky-note"></i><h3>No notes found</h3><p>Try clearing filters or create a new note!</p></div>`;
          return;
        }

        grid.innerHTML = filteredNotes
          .sort((a, b) => b.createdAt - a.createdAt)
          .map((n) => {
            const tagBadges = (n.tags || [])
              .map(
                (t) =>
                  `<span class="badge" style="font-size:0.7em; margin-right:4px;">#${t}</span>`,
              )
              .join("");
            return `
                <div class="note-card color-${n.color}">
                    <div class="note-actions">
                        <button onclick="deleteNote('${n.id}')"><i class="fas fa-trash"></i></button>
                    </div>
                    <h4>${n.title}</h4>
                    <p style="white-space: pre-wrap;">${n.content}</p>
                    <div style="margin-top: 8px;">${tagBadges}</div>
                    <div class="note-date">${new Date(n.createdAt).toLocaleDateString()}</div>
                </div>
            `;
          })
          .join("");
      }

      // =============================================
      // ðŸ… POMODORO TIMER
      // =============================================
      document
        .getElementById("pomo-start")
        .addEventListener("click", togglePomodoro);
      document
        .getElementById("pomo-reset")
        .addEventListener("click", resetPomodoro);
      document
        .getElementById("pomo-skip")
        .addEventListener("click", skipPomodoro);

      document.querySelectorAll(".mode-tab").forEach((btn) => {
        btn.addEventListener("click", (e) => {
          document
            .querySelectorAll(".mode-tab")
            .forEach((b) => b.classList.remove("active"));
          e.target.classList.add("active");
          pomodoroMode = e.target.dataset.mode;
          resetPomodoro();
        });
      });

      document
        .getElementById("save-timer-settings")
        .addEventListener("click", saveTimerSettings);

      function togglePomodoro() {
        if (pomodoroRunning) {
          clearInterval(pomodoroTimer);
          pomodoroRunning = false;
          document.getElementById("pomo-icon").className = "fas fa-play";
        } else {
          pomodoroRunning = true;
          document.getElementById("pomo-icon").className = "fas fa-pause";
          pomodoroTimer = setInterval(tickPomodoro, 1000);

          // Track early bird / night owl
          const hour = new Date().getHours();
          if (hour < 7) {
            db.ref(`studyData/${currentUser.uid}/earlyBird`)
              .set(true)
              .catch((err) => {
                console.error("Error setting early bird achievement:", err);
              });
          }
          if (hour >= 23) {
            db.ref(`studyData/${currentUser.uid}/nightOwl`)
              .set(true)
              .catch((err) => {
                console.error("Error setting night owl achievement:", err);
              });
          }
        }

        // Update PiP UI if open to show/hide timer header
        if (typeof pipWindowOpen !== "undefined" && pipWindowOpen) {
          updatePipContent();
        }
      }

      function tickPomodoro() {
        pomodoroSeconds--;
        updateTimerDisplay();

        if (pomodoroSeconds <= 0) {
          clearInterval(pomodoroTimer);
          pomodoroRunning = false;
          document.getElementById("pomo-icon").className = "fas fa-play";

          if (pomodoroMode === "work") {
            todayPomodoros++;
            totalFocusMinutes += pomodoroSettings.focus;
            studyData.today += pomodoroSettings.focus;

            db.ref(`pomodoroStats/${currentUser.uid}`)
              .update({
                todayCount: todayPomodoros,
                totalMinutes: totalFocusMinutes,
                lastSession: Date.now(),
              })
              .catch((err) => {
                console.error("Error updating pomodoro stats:", err);
              });

            updateStudyData();
            showToast("ðŸ… Pomodoro complete! Take a break!", "success");
            playNotificationSound();

            // Auto-play music if enabled
            if (
              pomodoroSettings.musicEnabled !== false &&
              musicTracks.length > 0
            ) {
              // Play random or next track
              if (!isPlaying) {
                playTrack();
              }
            }

            checkAchievements();
          } else {
            showToast("Break over! Ready to focus? ðŸ’ª", "warning");
          }

          // Auto switch mode
          if (pomodoroMode === "work") {
            pomodoroMode = todayPomodoros % 4 === 0 ? "long" : "short";
          } else {
            pomodoroMode = "work";
          }
          resetPomodoro();
        }
      }

      function resetPomodoro() {
        clearInterval(pomodoroTimer);
        pomodoroRunning = false;
        document.getElementById("pomo-icon").className = "fas fa-play";

        if (pomodoroMode === "work") {
          pomodoroSeconds = pomodoroSettings.focus * 60;
          document.getElementById("timer-label").textContent = "Focus Time";
        } else if (pomodoroMode === "short") {
          pomodoroSeconds = pomodoroSettings.shortBreak * 60;
          document.getElementById("timer-label").textContent = "Short Break";
        } else {
          pomodoroSeconds = pomodoroSettings.longBreak * 60;
          document.getElementById("timer-label").textContent = "Long Break";
        }
        updateTimerDisplay();

        // Update PiP UI if open
        if (typeof pipWindowOpen !== "undefined" && pipWindowOpen) {
          updatePipContent();
        }
      }

      function skipPomodoro() {
        pomodoroSeconds = 0;
        tickPomodoro();
      }

      function updateTimerDisplay() {
        const mins = Math.floor(pomodoroSeconds / 60);
        const secs = pomodoroSeconds % 60;
        const display = `${mins.toString().padStart(2, "0")}:${secs.toString().padStart(2, "0")}`;
        document.getElementById("timer-display").textContent = display;
        document.getElementById("focus-timer-display").textContent = display;
      }

      function saveTimerSettings() {
        pomodoroSettings = {
          focus: parseInt(document.getElementById("focus-duration").value),
          shortBreak: parseInt(document.getElementById("short-break").value),
          longBreak: parseInt(document.getElementById("long-break").value),
          dailyGoal: parseFloat(document.getElementById("daily-goal").value),
        };
        db.ref(`settings/${currentUser.uid}`)
          .set(pomodoroSettings)
          .catch((err) => {
            console.error("Error saving settings:", err);
          });
        document.getElementById("daily-goal-display").textContent =
          pomodoroSettings.dailyGoal + "h";
        resetPomodoro();
        showToast("Settings saved! âš™ï¸", "success");
      }

      function playNotificationSound() {
        const audio = new Audio(
          "data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdH2Onp+fn5+enp6dnZycm5ubmpqZmZiYl5eWlpWVlJSTk5KSkZGQkI+PjY2MjIuLioqJiYiIh4eGhoWFhISEg4OCgoGBgICAf39+fn19fHx7e3p6eXl4eHd3dnZ1dXR0c3NycnFxcHBvb25ubW1sbGtraWloaGdnZmZlZWRkY2NiYmFhYGBfX15eXV1cXFtbWlpZWVhYV1dWVlVVVFRTU1JSUVFQUFBPTk5NTUxMS0tKSklJSEhHR0ZGRkVFREREQ0NCQkFBQEA/Pz4+PT09PDw7Ozs6Ojo5OTk4ODg3Nzc2NjY1NTU0NDQzMzMyMjIxMTExMDAwLy8vLi4uLS0tLCwsKysrKioqKSkpKCgoJycnJiYmJSUlJCQkIyMjIiIiISEhICAg",
        );
        audio.play().catch(() => {});
      }

      // =============================================
      // ðŸ“ˆ STUDY TRACKING
      // =============================================
      function checkAndResetDaily() {
        const today = new Date().toDateString();
        if (studyData.lastStudyDate !== today) {
          const dayIndex = new Date().getDay();
          studyData.weekly[dayIndex] = studyData.today;
          studyData.today = 0;
          studyData.lastStudyDate = today;
          todayPomodoros = 0;
          db.ref(`pomodoroStats/${currentUser.uid}/todayCount`)
            .set(0)
            .catch((err) => {
              console.error("Error resetting daily pomodoro count:", err);
            });
        }
      }

      function updateStudyData() {
        const dayIndex = new Date().getDay();
        studyData.weekly[dayIndex] = studyData.today;
        studyData.lastStudyDate = new Date().toDateString();

        db.ref(`studyData/${currentUser.uid}`)
          .update({
            today: studyData.today,
            weekly: studyData.weekly,
            lastStudyDate: studyData.lastStudyDate,
            maxDailyStudy: Math.max(
              studyData.maxDailyStudy || 0,
              studyData.today,
            ),
          })
          .catch((err) => {
            console.error("Error updating study data:", err);
          });

        updateStudyDisplay();
        updateStreak();
      }

      function updateStudyDisplay() {
        const hours = Math.floor(studyData.today / 60);
        const mins = studyData.today % 60;
        document.getElementById("today-study-time").textContent =
          `${hours}h ${mins}m`;

        const goalMins = pomodoroSettings.dailyGoal * 60;
        const goalPerc = Math.min(
          100,
          Math.round((studyData.today / goalMins) * 100),
        );
        document.getElementById("study-goal-fill").style.width = goalPerc + "%";

        // Update weekly chart
        if (!studyData.weekly || studyData.weekly.length !== 7) {
          console.log("Initializing weekly study data");
          studyData.weekly = [0, 0, 0, 0, 0, 0, 0];
        }

        const maxWeekly = Math.max(...studyData.weekly, 60);
        const chart = document.getElementById("weekly-chart");

        if (!chart) {
          console.error("Weekly chart element not found!");
          return;
        }

        const days = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
        const today = new Date().getDay();

        console.log("Updating chart with data:", studyData.weekly);

        chart.innerHTML = studyData.weekly
          .map((mins, i) => {
            const height = Math.max(10, (mins / maxWeekly) * 100);
            const isToday = i === today;
            return `<div class="chart-bar ${isToday ? "active" : ""}" style="height: ${height}%;"><span>${days[i]}</span><div class="chart-value">${Math.round(mins)}m</div></div>`;
          })
          .join("");
      }

      function updateStreak() {
        console.log("updateStreak called with studyData:", studyData);
        const today = new Date().toDateString();
        console.log(
          "Today:",
          today,
          "Last study date:",
          studyData.lastStudyDate,
        );
        console.log("Today's study time:", studyData.today, "minutes");

        if (studyData.today >= 30 && studyData.lastStudyDate === today) {
          console.log("Eligible for streak update");
          if (!studyData.streakUpdatedToday) {
            console.log("Streak not updated today, updating...");
            studyData.streak = (studyData.streak || 0) + 1;
            studyData.streakUpdatedToday = true;
            console.log("New streak:", studyData.streak);

            db.ref(`studyData/${currentUser.uid}/streak`)
              .set(studyData.streak)
              .catch((err) => {
                console.error("Error updating streak:", err);
              });
            db.ref(`studyData/${currentUser.uid}/streakUpdatedToday`)
              .set(true)
              .catch((err) => {
                console.error("Error updating streak status:", err);
              });
          } else {
            console.log("Streak already updated today");
          }
        } else {
          console.log("Not eligible for streak update");
          console.log(
            "Condition check:",
            studyData.today >= 30,
            "and",
            studyData.lastStudyDate === today,
          );
        }

        const streakElement = document.getElementById("streak-count");
        if (streakElement) {
          streakElement.textContent = studyData.streak || 0;
          console.log("Streak displayed:", studyData.streak || 0);
        } else {
          console.error("Streak count element not found!");
        }

        const pomoStreakElement = document.getElementById("pomo-streak");
        if (pomoStreakElement) {
          pomoStreakElement.textContent = studyData.streak || 0;
        }
      }

      // =============================================
      // ðŸ† ACHIEVEMENTS
      // =============================================
      function renderAchievements() {
        const grid = document.getElementById("achievements-grid");
        if (!grid) {
          console.error("Achievements grid element not found!");
          return;
        }

        console.log(
          "Rendering achievements. Total:",
          achievementsList.length,
          "Unlocked:",
          unlockedAchievements.length,
        );

        grid.innerHTML = achievementsList
          .map((a) => {
            const unlocked = unlockedAchievements.includes(a.id);
            return `
                    <div class="achievement-card ${unlocked ? "" : "locked"}">
                        <div class="achievement-icon">${a.icon}</div>
                        <h4>${a.title}</h4>
                        <p>${a.desc}</p>
                    </div>
                `;
          })
          .join("");
      }

      function checkAchievements() {
        console.log("Checking achievements...");
        console.log(
          "Tasks:",
          tasks.length,
          "Completed:",
          tasks.filter((t) => t.completed).length,
        );
        console.log("Grades:", grades.length, "Notes:", notes.length);
        console.log("Study data:", studyData);

        const completedTasks = tasks.filter((t) => t.completed).length;
        const hasAGrade = grades.some((g) => g.score >= 90);
        const gpa = grades.length > 0 ? calculateGPAValue() : 0;

        const data = {
          tasks: tasks.length,
          completed: completedTasks,
          pomodoros: totalFocusMinutes / (pomodoroSettings.focus || 25),
          streak: studyData.streak || 0,
          hasAGrade,
          gpa,
          earlyBird: studyData.earlyBird || false,
          nightOwl: studyData.nightOwl || false,
          notes: notes.length,
          maxDailyStudy: studyData.maxDailyStudy || 0,
        };

        console.log("Achievement data:", data);

        let newUnlocks = [];
        achievementsList.forEach((a) => {
          try {
            if (!unlockedAchievements.includes(a.id) && a.condition(data)) {
              newUnlocks.push(a.id);
              showToast(`ðŸ† Achievement Unlocked: ${a.title}!`, "success");
              console.log(`Unlocked achievement: ${a.title}`);
            }
          } catch (error) {
            console.error(`Error checking achievement ${a.id}:`, error);
          }
        });

        console.log("New unlocks:", newUnlocks);

        if (newUnlocks.length > 0) {
          unlockedAchievements = [...unlockedAchievements, ...newUnlocks];
          console.log("Updated unlocked achievements:", unlockedAchievements);

          db.ref(`achievements/${currentUser.uid}`)
            .set(unlockedAchievements)
            .then(() => {
              console.log("Achievements saved successfully");
              renderAchievements();
            })
            .catch((err) => {
              console.error("Error saving achievements:", err);
              showToast("Error saving achievements", "error");
            });
        } else {
          console.log("No new achievements unlocked");
        }
      }

      function calculateGPAValue() {
        if (grades.length === 0) return 0;
        let totalPoints = 0,
          totalCredits = 0;
        grades.forEach((g) => {
          totalPoints += getGradePoints(g.score) * g.credits;
          totalCredits += g.credits;
        });
        return totalPoints / totalCredits;
      }

      // =============================================
      // ðŸ§ª TESTING FUNCTIONS
      // =============================================

      // Function to simulate study activity for testing streaks
      window.simulateStudy = function (minutes = 30) {
        console.log(`Simulating ${minutes} minutes of study...`);

        // Update today's study time
        studyData.today = (studyData.today || 0) + minutes;
        studyData.lastStudyDate = new Date().toDateString();

        // Update weekly data
        const todayIndex = new Date().getDay();
        if (!studyData.weekly || studyData.weekly.length !== 7) {
          studyData.weekly = [0, 0, 0, 0, 0, 0, 0];
        }
        studyData.weekly[todayIndex] = studyData.today;

        // Update in database
        updateStudyData();
        updateStudyDisplay();
        updateStreak();

        showToast(`Added ${minutes} minutes to today's study!`, "success");
      };

      // Function to add test tasks
      window.addTestTasks = function (count = 3) {
        console.log(`Adding ${count} test tasks...`);

        for (let i = 0; i < count; i++) {
          const task = {
            title: `Test Task ${i + 1}`,
            subject: "Test Subject",
            category: "Homework",
            priority: "Medium",
            dueDate: new Date(Date.now() + 86400000 * (i + 1))
              .toISOString()
              .split("T")[0],
            estimated: 30,
            notes: `This is test task #${i + 1}`,
            completed: false,
            createdAt: Date.now() - i * 3600000,
          };

          db.ref(`tasks/${currentUser.uid}`)
            .push(task)
            .then((result) => {
              console.log(`Test task ${i + 1} added:`, result.key);
              tasks.push({ id: result.key, ...task });
            })
            .catch((err) => {
              console.error(`Error adding test task ${i + 1}:`, err);
            });
        }

        renderTasks();
        updateStats();
        showToast(`Added ${count} test tasks!`, "success");
      };

      // Function to complete a random task
      window.completeRandomTask = function () {
        const pendingTasks = tasks.filter((t) => !t.completed);
        if (pendingTasks.length === 0) {
          showToast("No pending tasks to complete!", "error");
          return;
        }

        const randomTask =
          pendingTasks[Math.floor(Math.random() * pendingTasks.length)];
        window.toggleComplete(randomTask.id, false);
        showToast(`Completed task: ${randomTask.title}`, "success");
      };

      // =============================================
      // ðŸŽ¯ FOCUS MODE
      // =============================================
      document
        .getElementById("focus-mode-btn")
        .addEventListener("click", () => {
          document.getElementById("focus-mode").classList.remove("hidden");
          document.getElementById("focus-quote").textContent =
            `"${quotes[Math.floor(Math.random() * quotes.length)]}"`;
          if (!pomodoroRunning) togglePomodoro();
        });

      document.getElementById("exit-focus").addEventListener("click", () => {
        document.getElementById("focus-mode").classList.add("hidden");
      });

      document.getElementById("focus-pause").addEventListener("click", () => {
        togglePomodoro();
        document.getElementById("focus-pause").innerHTML = pomodoroRunning
          ? '<i class="fas fa-pause"></i> Pause'
          : '<i class="fas fa-play"></i> Resume';
      });

      // =============================================
      // ðŸŽ›ï¸ UI & NAVIGATION
      // =============================================
      function showSection(sectionId) {
        document
          .querySelectorAll(".section-content")
          .forEach((s) => s.classList.add("hidden"));
        document
          .getElementById(`section-${sectionId}`)
          .classList.remove("hidden");
        document
          .querySelectorAll(".nav-tab")
          .forEach((t) => t.classList.remove("active"));
        document
          .querySelector(`.nav-tab[data-section="${sectionId}"]`)
          .classList.add("active");
      }

      document.querySelectorAll(".nav-tab").forEach((tab) => {
        tab.addEventListener("click", () => showSection(tab.dataset.section));
      });

      document.querySelectorAll(".list-tab").forEach((btn) => {
        btn.addEventListener("click", (e) => {
          document
            .querySelectorAll(".list-tab")
            .forEach((b) => b.classList.remove("active"));
          e.target.classList.add("active");
          currentView = e.target.dataset.view;
          renderTasks();
        });
      });

      document
        .getElementById("filter-category")
        .addEventListener("change", (e) => {
          currentFilter = e.target.value;
          renderTasks();
        });

      document.getElementById("sort-tasks").addEventListener("change", (e) => {
        currentSort = e.target.value;
        renderTasks();
      });

      document.getElementById("search-input").addEventListener("input", (e) => {
        searchQuery = e.target.value;
        renderTasks();
      });

      document
        .getElementById("toggle-form-btn")
        .addEventListener("click", () => {
          document.getElementById("task-form").classList.toggle("hidden");
        });

      document
        .getElementById("close-form-btn")
        .addEventListener("click", () => {
          document.getElementById("task-form").classList.add("hidden");
        });

      // Theme Toggle
      document.getElementById("theme-toggle").addEventListener("click", () => {
        const isDark = document.body.getAttribute("data-theme") === "dark";
        document.body.setAttribute("data-theme", isDark ? "" : "dark");
        document.querySelector("#theme-toggle i").className = isDark
          ? "fas fa-moon"
          : "fas fa-sun";
        localStorage.setItem("theme", isDark ? "light" : "dark");
      });

      if (localStorage.getItem("theme") === "dark") {
        document.body.setAttribute("data-theme", "dark");
        document.querySelector("#theme-toggle i").className = "fas fa-sun";
      }

      // Export CSV
      document.getElementById("export-btn").addEventListener("click", () => {
        if (tasks.length === 0) return showToast("No data!", "error");
        let csv =
          "data:text/csv;charset=utf-8,Title,Subject,Category,Priority,Due,Status\n";
        tasks.forEach((t) => {
          csv += `"${t.title}","${t.subject}","${t.category}","${t.priority}","${t.dueDate}","${t.completed ? "Done" : "Pending"}"\n`;
        });
        const link = document.createElement("a");
        link.href = encodeURI(csv);
        link.download = `tasks_${new Date().toISOString().split("T")[0]}.csv`;
        link.click();
        showToast("Exported! ðŸ“„", "success");
      });

      // Close modals
      document.querySelectorAll(".modal-overlay").forEach((m) => {
        m.addEventListener("click", (e) => {
          if (e.target === m) m.classList.add("hidden");
        });
      });

      // Keyboard shortcuts
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
          document
            .querySelectorAll(".modal-overlay")
            .forEach((m) => m.classList.add("hidden"));
          document.getElementById("focus-mode").classList.add("hidden");
        }
        if (e.ctrlKey && e.key === "n" && currentUser) {
          e.preventDefault();
          showSection("tasks");
          document.getElementById("task-form").classList.remove("hidden");
          document.getElementById("task-title").focus();
        }
      });

      // =============================================
      // ðŸ”” TOAST
      // =============================================
      function showToast(msg, type = "info") {
        const container = document.getElementById("toast-container");
        const toast = document.createElement("div");
        toast.className = `toast ${type}`;
        const icons = {
          success: "fa-check-circle",
          error: "fa-exclamation-circle",
          warning: "fa-exclamation-triangle",
          info: "fa-info-circle",
        };
        toast.innerHTML = `<i class="fas ${icons[type]}"></i> ${msg}`;
        container.appendChild(toast);
        setTimeout(() => {
          toast.style.animation = "slideIn 0.3s ease reverse";
          setTimeout(() => toast.remove(), 300);
        }, 3000);
      }

      // =============================================
      // ðŸ–¼ï¸ PICTURE-IN-PICTURE MODE
      // =============================================

      // PiP Window State
      let pipWindowOpen = false;
      let pipMode = "tasks"; // 'tasks' or 'timer'

      // DOM Elements for PiP
      const pipWindow = document.getElementById("pip-window");
      const pipTitle = document.getElementById("pip-title");
      const pipCloseBtn = document.getElementById("pip-close");
      const pipMinimizeBtn = document.getElementById("pip-minimize");
      const pipTaskList = document.getElementById("pip-task-list");
      const pipPomodoro = document.getElementById("pip-pomodoro");
      const pipTimer = document.getElementById("pip-timer");
      const pipStartStopBtn = document.getElementById("pip-start-stop");
      const pipResetBtn = document.getElementById("pip-reset");

      // Initialize PiP functionality
      function initializePip() {
        // Close button
        pipCloseBtn.addEventListener("click", () => {
          pipWindow.classList.add("hidden");
          pipWindowOpen = false;
        });

        // Minimize button
        pipMinimizeBtn.addEventListener("click", () => {
          // For now, just hide the window
          pipWindow.classList.add("hidden");
          pipWindowOpen = false;
        });

        // Toggle between task list and timer
        document.addEventListener("keydown", (e) => {
          if (e.ctrlKey && e.key === "p") {
            e.preventDefault();
            togglePipWindow();
          }
        });

        // Timer controls
        pipStartStopBtn.addEventListener("click", () => {
          if (pomodoroRunning) {
            pausePomodoro();
            pipStartStopBtn.innerHTML = '<i class="fas fa-play"></i>';
          } else {
            startPomodoro();
            pipStartStopBtn.innerHTML = '<i class="fas fa-pause"></i>';
          }
        });

        pipResetBtn.addEventListener("click", () => {
          resetPomodoro();
          updatePipTimerDisplay();
        });

        // Update PiP timer display when main timer updates
        setInterval(updatePipTimerDisplay, 1000);
      }

      // Toggle PiP window visibility (Enhanced with Document PiP API)
      async function togglePipWindow() {
        // Check if Document Picture-in-Picture API is supported
        if ("documentPictureInPicture" in window) {
          // If PiP window is already open, close it
          if (window.documentPictureInPicture.window) {
            window.documentPictureInPicture.window.close();
            return;
          }

          try {
            // Request a new PiP window
            const pipWin = await window.documentPictureInPicture.requestWindow({
              width: 300,
              height: 300,
            });

            // Copy all style sheets to the new window to maintain look and feel
            [...document.styleSheets].forEach((styleSheet) => {
              try {
                const cssRules = [...styleSheet.cssRules]
                  .map((rule) => rule.cssText)
                  .join("");
                const style = document.createElement("style");
                style.textContent = cssRules;
                pipWin.document.head.appendChild(style);
              } catch (e) {
                const link = document.createElement("link");
                link.rel = "stylesheet";
                link.type = styleSheet.type;
                link.media = styleSheet.media;
                link.href = styleSheet.href;
                pipWin.document.head.appendChild(link);
              }
            });

            // Move the PiP content to the new window
            const pipContent = document.getElementById("pip-content");
            pipContent.style.display = "block"; // Ensure it's visible
            pipWin.document.body.appendChild(pipContent);

            // Update content based on mode
            updatePipContent();

            // Handle closing the PiP window
            pipWin.addEventListener("pagehide", (event) => {
              // Move content back to main window
              const pipContainer = document.getElementById("pip-window");
              pipContainer.appendChild(pipContent);
              pipWindowOpen = false;
            });

            pipWindowOpen = true;
          } catch (error) {
            console.error("Failed to enter Picture-in-Picture mode:", error);
            showToast("Failed to open floating window", "error");
          }
        } else {
          // Fallback to old "fake" PiP for browsers without API support
          if (pipWindowOpen) {
            pipWindow.classList.add("hidden");
            pipWindowOpen = false;
          } else {
            updatePipContent();
            pipWindow.classList.remove("hidden");
            pipWindowOpen = true;
          }
        }
      }

      // Update PiP content based on current mode
      function updatePipContent() {
        if (pipMode === "tasks") {
          renderPipTasks();
          pipTaskList.style.display = "block";
          pipPomodoro.style.display = "none";
          // Update title if in DOM-based PiP
          if (pipTitle) pipTitle.textContent = "Floating Tasks";
        } else {
          pipTaskList.style.display = "none";
          pipPomodoro.style.display = "block";
          // Update title if in DOM-based PiP
          if (pipTitle) pipTitle.textContent = "Pomodoro Timer";
          updatePipTimerDisplay();
          // Also show tasks below timer in pomodoro mode if user wants?
          // For now, let's keep them separate but allow easy toggling
        }
      }

      // Render tasks in PiP window
      function renderPipTasks() {
        // Ensure we have latest data
        if (!currentUser || !tasks) {
          pipTaskList.innerHTML =
            '<div class="pip-empty">No tasks available</div>';
          return;
        }

        let headerHtml = "";
        if (pomodoroRunning) {
          const mins = Math.floor(pomodoroSeconds / 60);
          const secs = pomodoroSeconds % 60;
          const display = `${mins.toString().padStart(2, "0")}:${secs.toString().padStart(2, "0")}`;
          headerHtml = `<div style="text-align:center; font-weight:bold; color:var(--primary); margin-bottom:8px; padding-bottom:8px; border-bottom:1px solid var(--border);">
            <i class="fas fa-stopwatch"></i> <span id="pip-mini-time-text">${display}</span>
            ${hardModeEnabled ? '<i class="fas fa-lock" style="font-size:0.8em; color:var(--danger)"></i>' : ""}
         </div>`;
        }

        const pendingTasks = tasks.filter((task) => !task.completed);

        if (pendingTasks.length === 0) {
          pipTaskList.innerHTML =
            '<div class="pip-empty">No pending tasks</div>';
          return;
        }

        // Show only the 5 most urgent tasks
        const urgentTasks = pendingTasks
          .sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate))
          .slice(0, 5);

        pipTaskList.innerHTML =
          headerHtml +
          urgentTasks
            .map(
              (task) => `
        <div class="pip-task-item" onclick="openEditTask('${task.id}')">
          <div class="pip-task-title">${task.title}</div>
          <div class="pip-task-due">Due: ${formatDate(new Date(task.dueDate))}</div>
        </div>
      `,
            )
            .join("");
      }

      // Update PiP timer display
      function updatePipTimerDisplay() {
        const minutes = Math.floor(pomodoroSeconds / 60);
        const seconds = pomodoroSeconds % 60;
        const display = `${minutes.toString().padStart(2, "0")}:${seconds.toString().padStart(2, "0")}`;

        if (pipTimer) {
          pipTimer.textContent = display;
        }

        // Also update mini timer in task view if present
        const miniTimer = pipTaskList
          ? pipTaskList.querySelector("#pip-mini-time-text")
          : null;
        if (miniTimer) {
          miniTimer.textContent = display;
        }
      }

      // Function to switch PiP mode
      function switchPipMode(mode) {
        pipMode = mode;
        updatePipContent();
      }

      // Initialize PiP when DOM is loaded
      document.addEventListener("DOMContentLoaded", initializePip);

      // Add keyboard shortcut for PiP
      document.addEventListener("keydown", (e) => {
        if (e.ctrlKey && e.shiftKey && e.key === "P") {
          e.preventDefault();
          togglePipWindow();
        }
      });

      // =============================================
      // ðŸŽµ STUDY MUSIC PLAYER
      // =============================================

      // Music Player Elements
      const musicPlayer = document.getElementById("music-player");
      const audioPlayer = document.getElementById("audio-player");
      const playPauseBtn = document.getElementById("play-pause");
      const prevBtn = document.getElementById("prev-track");
      const nextBtn = document.getElementById("next-track");
      const progressBar = document.getElementById("progress-bar");
      const currentTimeEl = document.getElementById("current-time");
      const totalTimeEl = document.getElementById("total-time");
      const volumeSlider = document.getElementById("volume-slider");
      const tracksList = document.getElementById("tracks-list");
      const currentTrackEl = document.getElementById("current-track");
      const closeMusicBtn = document.getElementById("close-music");

      // Music tracks using public test files (User should replace these with their own)
      const musicTracks = [
        {
          id: 1,
          title: "Focus Flow",
          artist: "StudentFocus",
          src: "music/focus-flow.mp3",
          duration: "6:12",
        },
        {
          id: 2,
          title: "Deep Concentration",
          artist: "StudentFocus",
          src: "music/deep-concentration.mp3",
          duration: "7:05",
        },
        {
          id: 3,
          title: "Calming Mind",
          artist: "StudentFocus",
          src: "music/calming-mind.mp3",
          duration: "5:44",
        },
        {
          id: 4,
          title: "Productive Pulse",
          artist: "StudentFocus",
          src: "music/productive-pulse.mp3",
          duration: "5:02",
        },
        {
          id: 5,
          title: "Silent Study",
          artist: "StudentFocus",
          src: "music/silent-study.mp3",
          duration: "5:53",
        },
      ];

      let currentTrackIndex = 0;
      let isPlaying = false;

      // Initialize music player
      function initMusicPlayer() {
        console.log("Initializing music player...");
        loadTracks();
        loadTrack(currentTrackIndex);

        // Event listeners
        console.log("Setting up music event listeners...");
        playPauseBtn.addEventListener("click", togglePlayPause);
        prevBtn.addEventListener("click", prevTrack);
        nextBtn.addEventListener("click", nextTrack);
        audioPlayer.addEventListener("ended", nextTrack);
        audioPlayer.addEventListener("timeupdate", updateProgress);
        progressBar.addEventListener("change", setProgress);
        volumeSlider.addEventListener("input", setVolume);
        closeMusicBtn.addEventListener("click", () => {
          musicPlayer.classList.add("hidden");
        });

        // Keyboard shortcuts
        document.addEventListener("keydown", (e) => {
          if (e.ctrlKey && e.key === "m") {
            e.preventDefault();
            toggleMusicPlayer();
          }
          if (e.key === " ") {
            // Spacebar to play/pause when music player is active
            if (!musicPlayer.classList.contains("hidden")) {
              e.preventDefault();
              togglePlayPause();
            }
          }
        });
      }

      // Load tracks into playlist
      function loadTracks() {
        tracksList.innerHTML = "";
        musicTracks.forEach((track, index) => {
          const trackElement = document.createElement("div");
          trackElement.className = "track-item";
          trackElement.innerHTML = `
          <div>
            <strong>${track.title}</strong>
            <div class="artist">${track.artist}</div>
          </div>
          <div>${track.duration}</div>
        `;
          trackElement.addEventListener("click", () => {
            loadTrack(index);
            playTrack();
            highlightActiveTrack(index);
          });
          tracksList.appendChild(trackElement);
        });
        highlightActiveTrack(currentTrackIndex);
      }

      // Load a specific track
      function loadTrack(index) {
        currentTrackIndex = index;
        const track = musicTracks[index];
        audioPlayer.src = track.src;
        currentTrackEl.textContent = track.title;

        // Try to load the duration once metadata is loaded
        audioPlayer.onloadedmetadata = function () {
          totalTimeEl.textContent = formatTime(audioPlayer.duration);
        };

        // Handle loading errors
        audioPlayer.onerror = function (e) {
          console.error("Error loading audio:", e);
          showToast(
            "Error loading music track. Please try another track.",
            "error",
          );
        };

        highlightActiveTrack(index);
      }

      // Highlight the active track in the playlist
      function highlightActiveTrack(index) {
        const trackItems = document.querySelectorAll(".track-item");
        trackItems.forEach((item, i) => {
          if (i === index) {
            item.classList.add("active");
          } else {
            item.classList.remove("active");
          }
        });
      }

      let audioErrorCount = 0; // Track consecutive audio errors to prevent infinite loop

      // Play the track
      function playTrack() {
        console.log("Attempting to play track...");
        if (!audioPlayer.src) {
          console.error("No audio source set!");
          showToast("No audio track selected", "error");
          return;
        }

        audioPlayer
          .play()
          .then(() => {
            console.log("Audio playing successfully");
            isPlaying = true;
            audioErrorCount = 0; // Reset error count on success
            playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
          })
          .catch((error) => {
            console.error("Error playing audio:", error);
            audioErrorCount++;

            // Only try next track if we haven't exhausted all tracks
            if (audioErrorCount < musicTracks.length) {
              showToast(`Track failed, trying next...`, "warning");
              nextTrack();
            } else {
              // All tracks failed - stop trying
              showToast(
                "All music tracks failed to load. Please add valid MP3 files to the music folder.",
                "error",
              );
              isPlaying = false;
              audioErrorCount = 0; // Reset for future attempts
            }
          });
      }

      // Pause the track
      function pauseTrack() {
        console.log("Pausing track...");
        audioPlayer.pause();
        isPlaying = false;
        playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
      }

      // Toggle play/pause
      function togglePlayPause() {
        if (isPlaying) {
          pauseTrack();
        } else {
          playTrack();
        }
      }

      // Play next track
      function nextTrack() {
        currentTrackIndex = (currentTrackIndex + 1) % musicTracks.length;
        loadTrack(currentTrackIndex);
        playTrack();
      }

      // Play previous track
      function prevTrack() {
        currentTrackIndex =
          (currentTrackIndex - 1 + musicTracks.length) % musicTracks.length;
        loadTrack(currentTrackIndex);
        playTrack();
      }

      // Update progress bar
      function updateProgress() {
        const percent = (audioPlayer.currentTime / audioPlayer.duration) * 100;
        progressBar.value = percent;
        currentTimeEl.textContent = formatTime(audioPlayer.currentTime);
      }

      // Set progress bar
      function setProgress(e) {
        const width = this.clientWidth;
        const clickX = e.offsetX;
        const duration = audioPlayer.duration;

        audioPlayer.currentTime = (clickX / width) * duration;
      }

      // Set volume
      function setVolume() {
        audioPlayer.volume = volumeSlider.value;
      }

      // Format time in MM:SS
      function formatTime(seconds) {
        const min = Math.floor(seconds / 60);
        const sec = Math.floor(seconds % 60);
        return `${min}:${sec < 10 ? "0" : ""}${sec}`;
      }

      // Toggle music player visibility
      function toggleMusicPlayer() {
        if (musicPlayer.classList.contains("hidden")) {
          musicPlayer.classList.remove("hidden");
        } else {
          musicPlayer.classList.add("hidden");
        }
      }

      // Floating Music Player (PiP)
      async function toggleMusicPip() {
        if (!("documentPictureInPicture" in window)) {
          showToast("PiP not supported in this browser", "error");
          return;
        }

        if (window.documentPictureInPicture.window) {
          // If any PiP window is open, close it (simplification: assume single PiP context for now or just close it)
          // Note: The API only supports one PiP window at a time per tab usually.
          window.documentPictureInPicture.window.close();
          return;
        }

        try {
          const pipWin = await window.documentPictureInPicture.requestWindow({
            width: 340,
            height: 400,
          });

          // Copy styles
          [...document.styleSheets].forEach((styleSheet) => {
            try {
              const cssRules = [...styleSheet.cssRules]
                .map((rule) => rule.cssText)
                .join("");
              const style = document.createElement("style");
              style.textContent = cssRules;
              pipWin.document.head.appendChild(style);
            } catch (e) {
              const link = document.createElement("link");
              link.rel = "stylesheet";
              link.type = styleSheet.type;
              link.media = styleSheet.media;
              link.href = styleSheet.href;
              pipWin.document.head.appendChild(link);
            }
          });

          // Move Music Player to new window
          const player = document.getElementById("music-player");
          const originalParent = player.parentNode;

          // Adjust styles for PiP
          player.classList.remove("hidden");
          player.style.position = "static"; // Reset fixed position
          player.style.width = "100%";
          player.style.height = "100vh"; // Full height of PiP window
          player.style.border = "none";
          player.style.borderRadius = "0";

          pipWin.document.body.appendChild(player);

          // Handle close
          pipWin.addEventListener("pagehide", () => {
            // Restore styles
            player.style.position = "";
            player.style.width = "";
            player.style.height = "";
            player.style.border = "";
            player.style.borderRadius = "";
            player.classList.add("hidden"); // Optional: hide on return or keep open? Let's hide to mimic close.
            // Actually, let's check if it was playing. If playing, maybe keep it visible?
            // For now, prompt user logic: restore to original parent.
            originalParent.appendChild(player);

            // If it was supposed to be hidden before, we rely on classList.
            // But toggleMusicPlayer modifies classList.
            // Let's ensure it's hidden if the user closed the window.
            player.classList.add("hidden");
          });
        } catch (error) {
          console.error("Failed to open Music PiP:", error);
          showToast("Failed to open floating player", "error");
        }
      }

      // Initialize music player when DOM is loaded
      document.addEventListener("DOMContentLoaded", () => {
        initMusicPlayer();
        const pipBtn = document.getElementById("music-pip-btn");
        if (pipBtn) {
          pipBtn.addEventListener("click", toggleMusicPip);
        }

        const pomoPipBtn = document.getElementById("pomodoro-pip-btn");
        if (pomoPipBtn) {
          pomoPipBtn.addEventListener("click", () =>
            togglePipWindow("pomodoro"),
          );
        }
      });

      // =============================================
      // ðŸ”” DESKTOP NOTIFICATIONS
      // =============================================

      // Request notification permission
      function requestNotificationPermission() {
        if ("Notification" in window) {
          Notification.requestPermission().then((permission) => {
            if (permission === "granted") {
              console.log("Notification permission granted.");
            } else if (permission === "denied") {
              console.log("Notification permission denied.");
            }
          });
        }
      }

      // Check and request notification permission
      if ("Notification" in window) {
        if (Notification.permission === "default") {
          // Ask for permission after user interaction
          document.addEventListener(
            "click",
            function requestPerm() {
              requestNotificationPermission();
              document.removeEventListener("click", requestPerm);
            },
            { once: true },
          );
        }
      }

      // Show desktop notification
      function showDesktopNotification(title, body, icon = "fas fa-bell") {
        if ("Notification" in window && Notification.permission === "granted") {
          const notification = new Notification(title, {
            body: body,
            icon: getIconAsEmoji(icon), // Convert FA icon to emoji or fallback
            tag: "studentfocus-notification",
          });

          // Auto close after 5 seconds
          setTimeout(() => {
            if (notification) {
              notification.close();
            }
          }, 5000);

          return notification;
        } else {
          // Fallback to toast notification if browser doesn't support or permission denied
          showToast(body, "info");
        }
      }

      // Helper function to convert FA icons to emojis or return default
      function getIconAsEmoji(iconClass) {
        // This is a simplified conversion - in a real app you might have a mapping
        if (iconClass.includes("bell")) return "ðŸ””";
        if (iconClass.includes("check")) return "âœ…";
        if (iconClass.includes("clock")) return "â°";
        if (iconClass.includes("hourglass")) return "â³";
        return "ðŸ””"; // Default bell emoji
      }

      // Check for upcoming tasks and send notifications
      function checkUpcomingTasks() {
        if (!currentUser || !tasks) return;

        const now = new Date();
        const oneHourLater = new Date(now.getTime() + 60 * 60 * 1000); // 1 hour in milliseconds

        const upcomingTasks = tasks.filter((task) => {
          if (task.completed) return false;
          const dueDate = new Date(task.dueDate);
          return dueDate > now && dueDate <= oneHourLater;
        });

        upcomingTasks.forEach((task) => {
          const dueDate = new Date(task.dueDate);
          const timeDiff = dueDate - now;
          const minutesUntilDue = Math.ceil(timeDiff / (1000 * 60));

          showDesktopNotification(
            `Task Due Soon: ${task.title}`,
            `Due in ${minutesUntilDue} minute${minutesUntilDue !== 1 ? "s" : ""}. Subject: ${task.subject}`,
          );
        });
      }

      // Check for upcoming tasks periodically (every 5 minutes)
      setInterval(checkUpcomingTasks, 5 * 60 * 1000); // 5 minutes

      // Send notification when task is completed
      function notifyTaskCompletion(task) {
        showDesktopNotification(
          "Task Completed! ðŸŽ‰",
          `You completed: ${task.title}`,
        );
      }

      // Send notification when pomodoro session completes
      function notifyPomodoroCompletion() {
        showDesktopNotification(
          "Pomodoro Complete! ðŸ…",
          "Take a break or start another session.",
        );
      }

      // Send notification when study streak increases
      function notifyStreakUpdate(streakCount) {
        showDesktopNotification(
          `Study Streak: ${streakCount} Days! ðŸ”¥`,
          "Great job maintaining your streak!",
        );
      }

      // Send notification when achievement is unlocked
      function notifyAchievement(achievement) {
        showDesktopNotification(
          `Achievement Unlocked: ${achievement.title}! ðŸ†`,
          achievement.desc,
        );
      }

      // Enhanced show toast to also potentially trigger desktop notifications
      function showToastEnhanced(message, type = "info", alsoNotify = false) {
        showToast(message, type);
        if (alsoNotify) {
          showDesktopNotification("StudentFocus Update", message);
        }
      }

      // Add notification check when user logs in
      function onUserLogin() {
        // Check for upcoming tasks once user is logged in
        setTimeout(checkUpcomingTasks, 2000); // Wait a bit for data to load
      }

      // Utility function to format dates
      function formatDate(date) {
        if (!(date instanceof Date)) {
          date = new Date(date);
        }
        return date.toLocaleDateString();
      }

      // =============================================
      // ðŸ“Š ADVANCED ANALYTICS
      // =============================================

      // Generate a CSS Conic Gradient Pie Chart
      function createSubjectDistributionChart() {
        // Calculate data from tasks and grades
        const subjectTimeMap = {};
        let totalTime = 0;

        // Use tasks for estimated time data
        if (tasks && tasks.length > 0) {
          tasks.forEach((task) => {
            if (task.completed) {
              const time = task.estimated || 30; // Default 30 mins if not specified
              subjectTimeMap[task.subject] =
                (subjectTimeMap[task.subject] || 0) + time;
              totalTime += time;
            }
          });
        }

        // If no data, show placeholder
        if (totalTime === 0) {
          updateSubjectDistributionUI({}, 0);
          return;
        }

        updateSubjectDistributionUI(subjectTimeMap, totalTime);
      }

      // Update UI with subject distribution info and Pie Chart
      function updateSubjectDistributionUI(data, total) {
        let analyticsSection = document.querySelector(".analytics-section");
        if (!analyticsSection) {
          analyticsSection = document.createElement("div");
          analyticsSection.className = "analytics-section";
          analyticsSection.innerHTML = `
          <h3>ðŸ“Š Subject Distribution</h3>
          <div class="chart-flex-container">
            <div id="subject-pie-chart" class="pie-chart"></div>
            <div id="subject-legend" class="chart-legend"></div>
          </div>
          <h3>ðŸŒ¡ï¸ Activity Heatmap</h3>
          <div id="activity-heatmap" class="heatmap-container"></div>
        `;

          const dashboardContainer = document.querySelector(
            ".dashboard-container",
          );
          if (dashboardContainer)
            document
              .querySelector(".content-wrapper")
              .appendChild(analyticsSection);
        }

        const pieChart = document.getElementById("subject-pie-chart");
        const legend = document.getElementById("subject-legend");

        if (!pieChart || !legend) return;

        if (total === 0) {
          pieChart.style.background = "#e0e0e0";
          legend.innerHTML =
            "<p>No data yet. Complete tasks to see analytics!</p>";
          return;
        }

        // Generate Gradient String
        let gradientParts = [];
        let currentDeg = 0;
        const colors = [
          "#FF6384",
          "#36A2EB",
          "#FFCE56",
          "#4BC0C0",
          "#9966FF",
          "#FF9F40",
        ];

        let colorIndex = 0;
        let legendHtml = "";

        Object.entries(data).forEach(([subject, time]) => {
          const percentage = (time / total) * 100;
          const deg = (percentage / 100) * 360;
          const color = colors[colorIndex % colors.length];

          gradientParts.push(
            `${color} ${currentDeg}deg ${currentDeg + deg}deg`,
          );
          currentDeg += deg;

          legendHtml += `
          <div class="legend-item">
            <span class="legend-color" style="background:${color}"></span>
            <span class="legend-text">${subject} (${Math.round(percentage)}%)</span>
          </div>
        `;
          colorIndex++;
        });

        pieChart.style.background = `conic-gradient(${gradientParts.join(", ")})`;
        legend.innerHTML = legendHtml;

        // Update Heatmap
        updateActivityHeatmap();
      }

      // Create GitHub-style activity heatmap
      function updateActivityHeatmap() {
        const heatmapContainer = document.getElementById("activity-heatmap");
        if (!heatmapContainer) return;

        // Generate the last 4 weeks of data (simulation based on studyData)
        let html = '<div class="heatmap-grid">';

        // Headers
        const days = ["S", "M", "T", "W", "T", "F", "S"];
        days.forEach((d) => (html += `<div class="heatmap-header">${d}</div>`));

        // Calculate dates
        // We will show 28 days (4 weeks)
        // Map studyData.weekly to the current week
        const today = new Date();
        const dayOfWeek = today.getDay(); // 0-6

        // Create a flat array of intensity levels (0-3)
        // Historical data would come from DB, here we simulate mostly empty for past weeks + current week data
        let intensityData = Array(28).fill(0);

        // Fill current week based on studyData.weekly
        // week starts Sunday(0). studyData.weekly indexes 0-6 correspond to Sun-Sat
        // We need to place them in the last row of our 4 week grid (indices 21-27)
        studyData.weekly.forEach((mins, idx) => {
          let intensity = 0;
          if (mins > 120) intensity = 3;
          else if (mins > 60) intensity = 2;
          else if (mins > 0) intensity = 1;

          // idx is 0(Sun) to 6(Sat)
          // We want to fill the correct slot based on "current week".
          // Simplification: Just fill the last 7 slots with this week's data order
          intensityData[21 + idx] = intensity;
        });

        // Render cells
        intensityData.forEach((level) => {
          let colorClass = "intensity-0";
          if (level === 1) colorClass = "intensity-1";
          if (level === 2) colorClass = "intensity-2";
          if (level === 3) colorClass = "intensity-3";

          html += `<div class="heatmap-cell ${colorClass}" title="Study level: ${level}"></div>`;
        });

        html += "</div>";
        heatmapContainer.innerHTML = html;
      }

      // =============================================
      // ðŸ“… INTERACTIVE CALENDAR
      // =============================================
      let currentCalendarDate = new Date();
      let selectedDate = new Date();

      function initCalendar() {
        // Event Listeners
        document
          .getElementById("prev-month")
          .addEventListener("click", () => changeMonth(-1));
        document
          .getElementById("next-month")
          .addEventListener("click", () => changeMonth(1));

        renderCalendar();
      }

      function changeMonth(delta) {
        currentCalendarDate.setMonth(currentCalendarDate.getMonth() + delta);
        renderCalendar();
      }

      function renderCalendar() {
        const year = currentCalendarDate.getFullYear();
        const month = currentCalendarDate.getMonth();

        // Update Header
        const monthNames = [
          "January",
          "February",
          "March",
          "April",
          "May",
          "June",
          "July",
          "August",
          "September",
          "October",
          "November",
          "December",
        ];
        document.getElementById("calendar-month-year").textContent =
          `${monthNames[month]} ${year}`;

        const grid = document.getElementById("calendar-grid");
        grid.innerHTML = "";

        // Calculate days
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const daysInMonth = lastDay.getDate();
        const startDayOfWeek = firstDay.getDay(); // 0 (Sun) - 6 (Sat)

        // Previous month filler days
        for (let i = 0; i < startDayOfWeek; i++) {
          const div = document.createElement("div");
          div.className = "calendar-day other-month";
          grid.appendChild(div);
        }

        // Current month days
        const today = new Date();

        for (let day = 1; day <= daysInMonth; day++) {
          const date = new Date(year, month, day);
          const div = document.createElement("div");
          div.className = "calendar-day";
          div.textContent = day;

          // Highlight Today
          if (date.toDateString() === today.toDateString()) {
            div.classList.add("today");
          }

          // Highlight Selected
          if (date.toDateString() === selectedDate.toDateString()) {
            div.classList.add("selected");
          }

          // Check for tasks on this day
          const hasTasks = tasks.some((t) => {
            const taskDate = new Date(t.dueDate);
            return (
              !t.completed && taskDate.toDateString() === date.toDateString()
            );
          });

          if (hasTasks) {
            div.classList.add("has-event");
          }

          div.addEventListener("click", () => {
            selectedDate = date;
            renderCalendar(); // re-render to update selected state
            showTasksForDate(date);
          });

          grid.appendChild(div);
        }
      }

      function showTasksForDate(date) {
        const list = document.getElementById("calendar-task-list");
        const dateString = date.toDateString();

        const daysTasks = tasks.filter((t) => {
          const taskDate = new Date(t.dueDate);
          return taskDate.toDateString() === dateString;
        });

        if (daysTasks.length === 0) {
          list.innerHTML = `<p class="text-muted">No tasks for ${date.toLocaleDateString()}</p>`;
          return;
        }

        list.innerHTML =
          `<h4>Tasks for ${date.toLocaleDateString()}</h4>` +
          daysTasks
            .map(
              (t) => `
        <div class="task-card small-card ${t.completed ? "completed" : ""}" style="margin-bottom: 8px; padding: 10px;">
          <div style="display:flex; justify-content:space-between; align-items:center">
             <span>${t.title}</span>
             <span class="badge ${t.priority}">${t.priority}</span>
          </div>
        </div>
      `,
            )
            .join("");
      }

      // Call init when tab is switched to calendar
      // We'll hook into the tab switching logic existing in the app
      // For now, simpler: auto-init on load
      document.addEventListener("DOMContentLoaded", initCalendar);

      // Function to generate analytics periodically
      function generateAnalytics() {
        createSubjectDistributionChart();
        updateActivityHeatmap();
      }

      // Initialize analytics when data is loaded
      function initAnalytics() {
        // Set up periodic analytics updates
        setInterval(generateAnalytics, 30000); // Update every 30 seconds
      }

      // Initialize analytics when DOM is loaded
      document.addEventListener("DOMContentLoaded", initAnalytics);

      // =============================================
      // ðŸŽ¯ POMODORO HARD MODE
      // =============================================

      // Variables for Hard Mode
      let hardModeEnabled = false;
      let sessionStartedInFocus = false;

      // Toggle Hard Mode
      function toggleHardMode() {
        hardModeEnabled = !hardModeEnabled;

        if (hardModeEnabled) {
          showToast("Hard Mode Enabled! Stay focused!", "info");
          // Check if we're currently in a session
          if (pomodoroRunning) {
            sessionStartedInFocus = true;
          }
        } else {
          showToast("Hard Mode Disabled", "info");
        }

        updateHardModeUI();
      }

      // Update UI to reflect Hard Mode status
      function updateHardModeUI() {
        const hardModeToggle = document.getElementById("hard-mode-toggle");
        if (hardModeToggle) {
          hardModeToggle.innerHTML = hardModeEnabled
            ? '<i class="fas fa-lock"></i> Hard Mode ON'
            : '<i class="fas fa-lock-open"></i> Hard Mode OFF';
          hardModeToggle.style.background = hardModeEnabled
            ? "var(--danger)"
            : "var(--primary)";
        }
      }

      // Detect when user leaves the tab/window
      function setupFocusDetection() {
        // Listen for visibility change (tab switching, window minimizing)
        document.addEventListener("visibilitychange", function () {
          if (document.hidden) {
            // User left the tab
            if (pomodoroRunning && hardModeEnabled) {
              handleFocusLoss();
            }
          } else {
            // User came back to the tab
            if (pomodoroRunning && hardModeEnabled) {
              // Check if they've been away too long (more than 30 seconds)
              const now = Date.now();
              if (now - lastVisibilityChangeTime > 30000) {
                // 30 seconds
                handleFocusLoss();
              }
            }
          }
          lastVisibilityChangeTime = Date.now();
        });

        // Listen for blur event (window loses focus)
        window.addEventListener("blur", function () {
          if (pomodoroRunning && hardModeEnabled) {
            // Add a small delay to prevent accidental triggers
            setTimeout(() => {
              if (document.hidden || !document.hasFocus()) {
                handleFocusLoss();
              }
            }, 500);
          }
        });

        // Track visibility change time
        let lastVisibilityChangeTime = Date.now();
      }

      // Handle when user loses focus during a session
      function handleFocusLoss() {
        // If PiP window is open, we considered it "focused" enough for strict mode
        if (pipWindowOpen) return;
        if (!hardModeEnabled || !pomodoroRunning) return;

        // End the current session and reset
        pausePomodoro();
        resetPomodoro();

        // Update stats - don't count this as a completed session
        // In a real implementation, you might decrease the streak

        // Show notification
        showDesktopNotification(
          "Focus Session Interrupted! ðŸš¨",
          "You left the app during a focus session in Hard Mode. Session reset.",
        );

        showToast("Session failed! You left during Hard Mode.", "error");

        // Update the UI to reflect the failure
        updatePomodoroDisplay();
      }

      // Enhanced pomodoro start for hard mode
      function startPomodoroHardMode() {
        if (hardModeEnabled) {
          sessionStartedInFocus = true;
          showToast("Hard Mode Session Started! Stay focused!", "info");
        }
        startPomodoro();
      }

      // Initialize focus detection
      document.addEventListener("DOMContentLoaded", setupFocusDetection);

      // Add hard mode toggle to the pomodoro controls if it doesn't exist
      function addHardModeToggle() {
        // Look for the pomodoro controls section and add a hard mode toggle
        const pomodoroControls = document.querySelector(".pomodoro-controls");
        if (pomodoroControls && !document.getElementById("hard-mode-toggle")) {
          const hardModeBtn = document.createElement("button");
          hardModeBtn.id = "hard-mode-toggle";
          hardModeBtn.className = "btn-icon";
          hardModeBtn.innerHTML =
            '<i class="fas fa-lock-open"></i> Hard Mode OFF';
          hardModeBtn.onclick = toggleHardMode;
          pomodoroControls.appendChild(hardModeBtn);
        }
      }

      // Initialize hard mode toggle
      document.addEventListener("DOMContentLoaded", addHardModeToggle);

      // =============================================
      // ðŸ–±ï¸ DRAGGABLE LOGIC & UTILS
      // =============================================
      function makeDraggable(element, handle) {
        let pos1 = 0,
          pos2 = 0,
          pos3 = 0,
          pos4 = 0;
        if (!handle) return;

        handle.onmousedown = dragMouseDown;

        function dragMouseDown(e) {
          e.preventDefault();
          pos3 = e.clientX;
          pos4 = e.clientY;
          document.onmouseup = closeDragElement;
          document.onmousemove = elementDrag;
        }

        function elementDrag(e) {
          e.preventDefault();
          pos1 = pos3 - e.clientX;
          pos2 = pos4 - e.clientY;
          pos3 = e.clientX;
          pos4 = e.clientY;

          // Ensure element stays within viewport
          const top = element.offsetTop - pos2;
          const left = element.offsetLeft - pos1;

          // Basic boundary checks (optional, but good for UX)
          // element.style.top = Math.max(0, Math.min(window.innerHeight - element.offsetHeight, top)) + "px";
          // element.style.left = Math.max(0, Math.min(window.innerWidth - element.offsetWidth, left)) + "px";

          element.style.top = top + "px";
          element.style.left = left + "px";
        }

        function closeDragElement() {
          document.onmouseup = null;
          document.onmousemove = null;
        }
      }

      // Initialize Draggable Elements on Load
      document.addEventListener("DOMContentLoaded", () => {
        // Make PiP Window Draggable (YouTube style)
        const pipWindow = document.getElementById("pip-window");
        const pipHeader = document.querySelector("#pip-window .pip-header");
        if (pipWindow && pipHeader) {
          makeDraggable(pipWindow, pipHeader);
        }

        // Make Music Player Draggable
        const playerWindow = document.getElementById("music-player");
        const playerHeader = document.querySelector(
          "#music-player .music-header",
        );
        if (playerWindow && playerHeader) {
          makeDraggable(playerWindow, playerHeader);
        }

        // Ensure "Completed" tab works and maybe auto-switch if user is confused?
        // For now, trust the tabs but maybe log basic stats
        console.log("App initialized. Ready.");
      });

      document.addEventListener("DOMContentLoaded", addHardModeToggle);
    </script>
  </body>
</html>
